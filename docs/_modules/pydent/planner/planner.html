
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  
  <!-- Licensed under the Apache 2.0 License -->
  <link rel="stylesheet" type="text/css" href="../../../_static/fonts/open-sans/stylesheet.css" />
  <!-- Licensed under the SIL Open Font License -->
  <link rel="stylesheet" type="text/css" href="../../../_static/fonts/source-serif-pro/source-serif-pro.css" />
  <link rel="stylesheet" type="text/css" href="../../../_static/css/bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="../../../_static/css/bootstrap-theme.min.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
    <title>pydent.planner.planner &#8212; Trident 1.0.0a2 documentation</title>
    <link rel="stylesheet" href="../../../_static/guzzle.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/custom.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  
   

  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Trident 1.0.0a2 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="container-wrapper">

      <div id="mobile-toggle">
        <a href="#"><span class="glyphicon glyphicon-align-justify" aria-hidden="true"></span></a>
      </div>
  <div id="left-column">
    <div class="sphinxsidebar"><a href="http://klavinslab.org/trident" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#70B7FD; color:#fff; position: absolute; top: 0; border: 0; left: 0; transform: scale(-1, 1);" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

<div>
    <div>
        <h1 align="center"><a href="../../../index.html">Trident</a>
        </h1>
    </div>
</div>

<p align="center" class="sidebar-subtitle">Trident version: <a href="https://pypi.org/project/pydent/">1.0.0a2</a></p>
<div>

</div>
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <h2>Table Of Contents</h2>
  </div>
  <div class="sidebar-toc">
    
    
      <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Trident Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../intro.html">Intro to Programmatic Science</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../browsing.html">Model browsing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../planning.html">Experiment Planning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer_notes.html">Developer Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tests.html">Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer/api_reference.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../versions.html">Version History</a></li>
</ul>

    
  </div>
</div>
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <div id="main-search">
      <form class="form-inline" action="../../../search.html" method="GET" role="form">
        <div class="input-group">
          <input name="q" type="text" class="form-control" placeholder="Search...">
        </div>
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div>
      
    </div>
  </div>
        <div id="right-column">
          
          <div role="navigation" aria-label="breadcrumbs navigation">
            <ol class="breadcrumb">
              <li><a href="../../../index.html">Docs</a></li>
              
                <li><a href="../../index.html">Module code</a></li>
              
              <li>pydent.planner.planner</li>
            </ol>
          </div>
          
          <div class="document clearer body">
            
  <h1>Source code for pydent.planner.planner</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Planner</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">webbrowser</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">Sequence</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">wraps</span>
<span class="kn">from</span> <span class="nn">uuid</span> <span class="k">import</span> <span class="n">uuid4</span>

<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>

<span class="kn">from</span> <span class="nn">pydent.aqsession</span> <span class="k">import</span> <span class="n">AqSession</span>
<span class="kn">from</span> <span class="nn">pydent.browser</span> <span class="k">import</span> <span class="n">Browser</span>
<span class="kn">from</span> <span class="nn">pydent.models</span> <span class="k">import</span> <span class="n">FieldValue</span><span class="p">,</span> <span class="n">Operation</span><span class="p">,</span> <span class="n">Plan</span>
<span class="kn">from</span> <span class="nn">pydent.planner.layout</span> <span class="k">import</span> <span class="n">PlannerLayout</span>
<span class="kn">from</span> <span class="nn">pydent.planner.utils</span> <span class="k">import</span> <span class="n">arr_to_pairs</span><span class="p">,</span> <span class="n">_id_getter</span><span class="p">,</span> <span class="n">get_subgraphs</span>
<span class="kn">from</span> <span class="nn">pydent.utils</span> <span class="k">import</span> <span class="n">make_async</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">empty_copy</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="k">import</span> <span class="n">deepcopy</span>

<span class="kn">import</span> <span class="nn">itertools</span>


<div class="viewcode-block" id="PlannerException"><a class="viewcode-back" href="../../../developer/_autosummary/_autosummary/pydent.planner.planner.html#pydent.planner.planner.PlannerException">[docs]</a><span class="k">class</span> <span class="nc">PlannerException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generic planner Exception&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="plan_verification_wrapper"><a class="viewcode-back" href="../../../developer/_autosummary/_autosummary/pydent.planner.planner.html#pydent.planner.planner.plan_verification_wrapper">[docs]</a><span class="k">def</span> <span class="nf">plan_verification_wrapper</span><span class="p">(</span><span class="n">fxn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A wrapper that verifies that all FieldValues or Operations passed</span>
<span class="sd">    as arguments exist in the plan.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@wraps</span><span class="p">(</span><span class="n">fxn</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">Planner</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PlannerException</span><span class="p">(</span>
                <span class="s2">&quot;Cannot apply &#39;verify_plan_models&#39; to a non-planner instance.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">FieldValue</span><span class="p">):</span>
                <span class="n">fv</span> <span class="o">=</span> <span class="n">arg</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contains_op</span><span class="p">(</span><span class="n">fv</span><span class="o">.</span><span class="n">operation</span><span class="p">):</span>
                    <span class="n">fv_ref</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fv</span><span class="o">.</span><span class="n">role</span><span class="p">,</span> <span class="n">fv</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;FieldValue </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2"> not found in planner.&quot;</span>
                    <span class="k">raise</span> <span class="n">PlannerException</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fv_ref</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">Operation</span><span class="p">):</span>
                <span class="n">op</span> <span class="o">=</span> <span class="n">arg</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contains_op</span><span class="p">(</span><span class="n">op</span><span class="p">):</span>
                    <span class="n">op_ref</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">operation_type</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Operation </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2"> not found in planner.&quot;</span>
                    <span class="k">raise</span> <span class="n">PlannerException</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">op_ref</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">fxn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">wrapper</span></div>


<div class="viewcode-block" id="Planner"><a class="viewcode-back" href="../../../developer/_autosummary/_autosummary/pydent.planner.planner.html#pydent.planner.planner.Planner">[docs]</a><span class="k">class</span> <span class="nc">Planner</span><span class="p">(</span><span class="n">logger</span><span class="o">.</span><span class="n">Loggable</span><span class="p">,</span> <span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A user-interface for making experimental plans and layouts.&quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">ITEM_SELECTION_PREFERENCE</span><span class="p">:</span>

        <span class="n">ANY</span> <span class="o">=</span> <span class="s2">&quot;ANY&quot;</span>  <span class="c1"># pick the first item that matches the set field_value</span>
        <span class="n">RESTRICT</span> <span class="o">=</span> <span class="s2">&quot;RESTRICT&quot;</span>  <span class="c1"># restrict to the currently set allowable_field_type</span>
        <span class="n">PREFERRED</span> <span class="o">=</span> <span class="s2">&quot;PREFERRED&quot;</span>  <span class="c1"># (default) pick the item that matches the currently set allowable_field_type, else</span>
        <span class="c1"># pick ANY item that matches the set field_value</span>
        <span class="n">RESTRICT_TO_ONE</span> <span class="o">=</span> <span class="s2">&quot;RESTRICT TO ONE&quot;</span>  <span class="c1"># will not select item if its being used in another active operation</span>
        <span class="n">_DEFAULT</span> <span class="o">=</span> <span class="n">PREFERRED</span>
        <span class="n">_CHOICES</span> <span class="o">=</span> <span class="p">[</span><span class="n">ANY</span><span class="p">,</span> <span class="n">RESTRICT</span><span class="p">,</span> <span class="n">PREFERRED</span><span class="p">,</span> <span class="n">RESTRICT_TO_ONE</span><span class="p">]</span>

    <span class="k">class</span> <span class="nc">ITEM_ORDER_PREFERENCE</span><span class="p">:</span>

        <span class="n">FIRST</span> <span class="o">=</span> <span class="s2">&quot;FIRST&quot;</span>  <span class="c1"># select first item</span>
        <span class="n">LAST</span> <span class="o">=</span> <span class="s2">&quot;LAST&quot;</span>  <span class="c1"># select last item</span>
        <span class="n">RANDOM</span> <span class="o">=</span> <span class="s2">&quot;RANDOM&quot;</span>  <span class="c1"># select random item</span>
        <span class="n">_DEFAULT</span> <span class="o">=</span> <span class="n">LAST</span>
        <span class="n">_CHOICES</span> <span class="o">=</span> <span class="p">[</span><span class="n">FIRST</span><span class="p">,</span> <span class="n">LAST</span><span class="p">,</span> <span class="n">RANDOM</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_or_plan</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plan_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">session_or_plan</span><span class="p">),</span> <span class="n">AqSession</span><span class="p">):</span>
            <span class="c1"># initialize with session</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session_or_plan</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_browser</span> <span class="o">=</span> <span class="n">Browser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">plan_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># load an existing plan</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_browser</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">plan_id</span><span class="p">,</span> <span class="s1">&#39;Plan&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">PlannerException</span><span class="p">(</span>
                        <span class="s2">&quot;Could not find plan with id=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">plan_id</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># create a new plan</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">Plan</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">session_or_plan</span><span class="p">),</span> <span class="n">Plan</span><span class="p">):</span>
            <span class="c1"># initialize with Plan</span>
            <span class="n">plan</span> <span class="o">=</span> <span class="n">session_or_plan</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">plan</span><span class="o">.</span><span class="n">session</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_browser</span> <span class="o">=</span> <span class="n">Browser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plan</span> <span class="o">=</span> <span class="n">plan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_logger</span><span class="p">(</span><span class="s2">&quot;Planner@plan_rid=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">rid</span><span class="p">))</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_check_plans_for_single_session</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">models</span><span class="p">):</span>
        <span class="n">session_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="nb">id</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">session</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">session_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PlannerException</span><span class="p">(</span><span class="s2">&quot;Plans have different session ids&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">models</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">session</span>


    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_plans</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">plans</span><span class="p">):</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_check_plans_for_single_session</span><span class="p">(</span><span class="n">plans</span><span class="p">)</span>
        <span class="n">browser</span> <span class="o">=</span> <span class="n">Browser</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">cache_plans</span><span class="p">(</span><span class="n">browser</span><span class="p">,</span> <span class="n">plans</span><span class="p">)</span>
        <span class="n">planners</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">plan</span> <span class="ow">in</span> <span class="n">plans</span><span class="p">:</span>
            <span class="n">planner</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">plan</span><span class="p">)</span>
            <span class="n">planner</span><span class="o">.</span><span class="n">_browser</span> <span class="o">=</span> <span class="n">browser</span>
            <span class="n">planners</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">planner</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">planners</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_cache_query</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;operations&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;field_values&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;wires_as_dest&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;operation&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;destination&#39;</span><span class="p">:</span> <span class="s1">&#39;operation&#39;</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;wires_as_source&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;operation&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;destination&#39;</span><span class="p">:</span> <span class="s1">&#39;operation&#39;</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;sample&quot;</span><span class="p">:</span> <span class="p">[],</span>
                    <span class="s2">&quot;item&quot;</span><span class="p">:</span> <span class="p">[],</span>
                    <span class="s2">&quot;operation&quot;</span><span class="p">:</span> <span class="p">[],</span>
                    <span class="s2">&quot;field_type&quot;</span><span class="p">:</span> <span class="p">[]</span>
                <span class="p">},</span>
                <span class="s1">&#39;plan_associations&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;plan&#39;</span><span class="p">],</span>
                <span class="s2">&quot;operation_type&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;field_types&quot;</span><span class="p">:</span> <span class="p">[]</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">plan</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plan</span>

    <span class="nd">@plan</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_plan</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plan</span> <span class="o">=</span> <span class="n">new_plan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># ots = self.browser.where(&#39;OperationType&#39;, {&#39;deployed&#39;: True})</span>
        <span class="c1"># self.browser.retrieve(ots, &#39;field_types&#39;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_browser</span><span class="o">.</span><span class="n">update_cache</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="p">],</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_browser</span><span class="o">.</span><span class="n">recursive_retrieve</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_query</span><span class="p">())</span>


    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">cache_plans</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">browser</span><span class="p">,</span> <span class="n">plans</span><span class="p">):</span>
        <span class="n">browser</span><span class="o">.</span><span class="n">recursive_retrieve</span><span class="p">(</span><span class="n">plans</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_cache_query</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">plan</span> <span class="ow">in</span> <span class="n">plans</span><span class="p">:</span>
            <span class="n">wire_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">plan</span><span class="o">.</span><span class="n">operations</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">plan</span><span class="o">.</span><span class="n">operations</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">fv</span> <span class="ow">in</span> <span class="n">op</span><span class="o">.</span><span class="n">field_values</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">fv</span><span class="o">.</span><span class="n">wires_as_dest</span><span class="p">:</span>
                            <span class="n">wire_dict</span><span class="p">[</span><span class="n">w</span><span class="o">.</span><span class="n">_primary_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">wire_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">_primary_key</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">fv</span><span class="o">.</span><span class="n">wires_as_source</span><span class="p">:</span>
                            <span class="n">wire_dict</span><span class="p">[</span><span class="n">w</span><span class="o">.</span><span class="n">_primary_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">wire_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">_primary_key</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
            <span class="n">plan</span><span class="o">.</span><span class="n">wires</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">wire_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">plans</span>

    <span class="k">def</span> <span class="nf">cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_plans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_browser</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">name</span>

    <span class="nd">@name</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">url</span> <span class="o">+</span> <span class="s2">&quot;plans?plan_id=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">webbrowser</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>

<div class="viewcode-block" id="Planner.create"><a class="viewcode-back" href="../../../developer/_autosummary/_autosummary/pydent.planner.planner.html#pydent.planner.planner.Planner.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the plan on Aquarium&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PlannerException</span><span class="p">(</span><span class="s2">&quot;Cannot create plan since it already exists on the server (plan_id=</span><span class="si">{}</span><span class="s2">)&quot;</span>
                                   <span class="s2">&quot; Did you mean .</span><span class="si">{save}</span><span class="s2">() push an update to the server plan? You&quot;</span>
                                   <span class="s2">&quot; can also create a copy of the new plan by calling .</span><span class="si">{replan}</span><span class="s2">().&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">plan_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">save</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                <span class="n">replan</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">replan</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">create</span><span class="p">()</span></div>

    <span class="c1"># TODO: fix this &#39;set_timeout&#39; to not be global</span>
<div class="viewcode-block" id="Planner.save"><a class="viewcode-back" href="../../../developer/_autosummary/_autosummary/pydent.planner.planner.html#pydent.planner.planner.Planner.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save the plan on Aquarium&quot;&quot;&quot;</span>
        <span class="n">prev_timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_AqSession__aqhttp</span><span class="o">.</span><span class="n">timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">set_timeout</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">set_timeout</span><span class="p">(</span><span class="n">prev_timeout</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span></div>

    <span class="k">def</span> <span class="nf">create_operation_by_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ot</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s2">&quot;planning&quot;</span><span class="p">):</span>
        <span class="n">op</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span>
        <span class="n">op</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">add_operation</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> created&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ot</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">op</span>

    <span class="k">def</span> <span class="nf">create_operation_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ot_id</span><span class="p">):</span>
        <span class="c1"># ot = self.browser.find(&#39;OperationType&#39;, ot_id)</span>
        <span class="n">ot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">OperationType</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">ot_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_operation_by_type</span><span class="p">(</span><span class="n">ot</span><span class="p">)</span>

<div class="viewcode-block" id="Planner.create_operation_by_name"><a class="viewcode-back" href="../../../developer/_autosummary/_autosummary/pydent.planner.planner.html#pydent.planner.planner.Planner.create_operation_by_name">[docs]</a>    <span class="k">def</span> <span class="nf">create_operation_by_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operation_type_name</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds a new operation to the plan&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;deployed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">operation_type_name</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">category</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">query</span><span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">category</span>
        <span class="n">ots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">OperationType</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ots</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Found more than one OperationType for query </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2">. Have you tried specifying the category?&quot;</span>
            <span class="k">raise</span> <span class="n">PlannerException</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ots</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">ots</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Could not find deployed OperationType </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2">.&quot;</span>
            <span class="k">raise</span> <span class="n">PlannerException</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">operation_type_name</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_operation_by_type</span><span class="p">(</span><span class="n">ots</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">models_are_equal</span><span class="p">(</span><span class="n">model1</span><span class="p">,</span> <span class="n">model2</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">model1</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">model2</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">model1</span><span class="o">.</span><span class="n">_primary_key</span> <span class="o">==</span> <span class="n">model2</span><span class="o">.</span><span class="n">_primary_key</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">model1</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">model2</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">get_operation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">operations</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="nb">id</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">op</span>

    <span class="nd">@plan_verification_wrapper</span>
    <span class="k">def</span> <span class="nf">get_wire</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fv1</span><span class="p">,</span> <span class="n">fv2</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">wire</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">wires</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models_are_equal</span><span class="p">(</span><span class="n">wire</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">fv1</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">models_are_equal</span><span class="p">(</span><span class="n">wire</span><span class="o">.</span><span class="n">destination</span><span class="p">,</span> <span class="n">fv2</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">(</span><span class="s2">&quot;found wire from </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fv1</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">fv2</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">wire</span>

<div class="viewcode-block" id="Planner.remove_wire"><a class="viewcode-back" href="../../../developer/_autosummary/_autosummary/pydent.planner.planner.html#pydent.planner.planner.Planner.remove_wire">[docs]</a>    <span class="nd">@plan_verification_wrapper</span>
    <span class="k">def</span> <span class="nf">remove_wire</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fv1</span><span class="p">,</span> <span class="n">fv2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes a wire between two field values from a plan</span>
<span class="sd">        :param fv1:</span>
<span class="sd">        :param fv2:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wire</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_wire</span><span class="p">(</span><span class="n">fv1</span><span class="p">,</span> <span class="n">fv2</span><span class="p">)</span>
        <span class="n">wires</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">wires</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">wire</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">(</span><span class="s2">&quot;removing wire from </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fv1</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">fv2</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="n">wires_as_source</span> <span class="o">=</span> <span class="n">fv1</span><span class="o">.</span><span class="n">wires_as_source</span>
            <span class="n">wires_as_dest</span> <span class="o">=</span> <span class="n">fv2</span><span class="o">.</span><span class="n">wires_as_dest</span>

            <span class="n">wires_as_source</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">wire</span><span class="p">)</span>
            <span class="n">wires_as_dest</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">wire</span><span class="p">)</span>

            <span class="n">fv1</span><span class="o">.</span><span class="n">wires_as_source</span> <span class="o">=</span> <span class="n">wires_as_source</span>
            <span class="n">fv2</span><span class="o">.</span><span class="n">wires_as_dest</span> <span class="o">=</span> <span class="n">wires_as_dest</span>

            <span class="n">wires</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">wire</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">wires</span> <span class="o">=</span> <span class="n">wires</span>
        <span class="k">return</span> <span class="n">wire</span></div>

    <span class="nd">@plan_verification_wrapper</span>
    <span class="k">def</span> <span class="nf">get_outgoing_wires</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fv</span><span class="p">):</span>
        <span class="n">wires</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">wire</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">wires</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">models_are_equal</span><span class="p">(</span><span class="n">wire</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">fv</span><span class="p">):</span>
                <span class="n">wires</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wire</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wires</span>

    <span class="nd">@plan_verification_wrapper</span>
    <span class="k">def</span> <span class="nf">get_incoming_wires</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fv</span><span class="p">):</span>
        <span class="n">wires</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">wire</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">wires</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">models_are_equal</span><span class="p">(</span><span class="n">wire</span><span class="o">.</span><span class="n">destination</span><span class="p">,</span> <span class="n">fv</span><span class="p">):</span>
                <span class="n">wires</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wire</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wires</span>

    <span class="k">def</span> <span class="nf">get_fv_successors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fv</span><span class="p">):</span>
        <span class="n">fvs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">wire</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_outgoing_wires</span><span class="p">(</span><span class="n">fv</span><span class="p">):</span>
            <span class="n">fvs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wire</span><span class="o">.</span><span class="n">destination</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fvs</span>

    <span class="k">def</span> <span class="nf">get_fv_predecessors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fv</span><span class="p">):</span>
        <span class="n">fvs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">wire</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_incoming_wires</span><span class="p">(</span><span class="n">fv</span><span class="p">):</span>
            <span class="n">fvs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wire</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fvs</span>

    <span class="k">def</span> <span class="nf">get_op_successors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">):</span>
        <span class="n">ops</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">op</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
            <span class="n">ops</span> <span class="o">+=</span> <span class="p">[</span><span class="n">fv</span><span class="o">.</span><span class="n">operation</span> <span class="k">for</span> <span class="n">fv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fv_successors</span><span class="p">(</span><span class="n">output</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">ops</span>

    <span class="k">def</span> <span class="nf">get_op_predecessors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">):</span>
        <span class="n">ops</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="nb">input</span> <span class="ow">in</span> <span class="n">op</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
            <span class="n">ops</span> <span class="o">+=</span> <span class="p">[</span><span class="n">fv</span><span class="o">.</span><span class="n">operation</span> <span class="k">for</span> <span class="n">fv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fv_predecessors</span><span class="p">(</span><span class="nb">input</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">ops</span>

<div class="viewcode-block" id="Planner._resolve_source_to_outputs"><a class="viewcode-back" href="../../../developer/_autosummary/_autosummary/pydent.planner.planner.html#pydent.planner.planner.Planner._resolve_source_to_outputs">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_resolve_source_to_outputs</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resolves a FieldValue or Operation to its sample output FieldValues</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">FieldValue</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">source</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;output&quot;</span><span class="p">:</span>
                <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">source</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Planner attempted to find matching&quot;</span> \
                      <span class="s2">&quot; allowable_field_types for an output FieldValue but&quot;</span> \
                      <span class="s2">&quot; found an input FieldValue&quot;</span>
                <span class="k">raise</span> <span class="n">PlannerException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">Operation</span><span class="p">):</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">fv</span> <span class="k">for</span> <span class="n">fv</span> <span class="ow">in</span> <span class="n">source</span><span class="o">.</span><span class="n">outputs</span> <span class="k">if</span> <span class="n">fv</span><span class="o">.</span><span class="n">field_type</span><span class="o">.</span><span class="n">ftype</span> <span class="o">==</span> <span class="s1">&#39;sample&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">outputs</span></div>

<div class="viewcode-block" id="Planner._resolve_destination_to_inputs"><a class="viewcode-back" href="../../../developer/_autosummary/_autosummary/pydent.planner.planner.html#pydent.planner.planner.Planner._resolve_destination_to_inputs">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_resolve_destination_to_inputs</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">destination</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resolves a FieldValue or Operation to its sample input FieldValues</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="n">FieldValue</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">destination</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;input&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">destination</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Planner attempted to find matching&quot;</span> \
                      <span class="s2">&quot; allowable_field_types for&quot;</span> \
                      <span class="s2">&quot; an input FieldValue but found an output FieldValue&quot;</span>
                <span class="k">raise</span> <span class="n">PlannerException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="n">Operation</span><span class="p">):</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">fv</span> <span class="k">for</span> <span class="n">fv</span> <span class="ow">in</span> <span class="n">destination</span><span class="o">.</span><span class="n">inputs</span>
                      <span class="k">if</span> <span class="n">fv</span><span class="o">.</span><span class="n">field_type</span><span class="o">.</span><span class="n">ftype</span> <span class="o">==</span> <span class="s1">&#39;sample&#39;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">inputs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PlannerException</span><span class="p">(</span>
                <span class="s2">&quot;Cannot resolve inputs, type must be a FieldValue or Operation, not a </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">destination</span><span class="p">)))</span></div>

<div class="viewcode-block" id="Planner._collect_matching_afts"><a class="viewcode-back" href="../../../developer/_autosummary/_autosummary/pydent.planner.planner.html#pydent.planner.planner.Planner._collect_matching_afts">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_collect_matching_afts</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">destination</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param source: a field value or operation source</span>
<span class="sd">        :type source: FieldValue|Operation</span>
<span class="sd">        :param destination: a field value or operation destination</span>
<span class="sd">        :type destination: FieldValue|Operation</span>
<span class="sd">        :return: tuple of matching allowable_field_type (aft) pairs, matching field_value inputs and matching field_value outputs</span>
<span class="sd">        :rtype: tuple</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="sd">&quot;&quot;&quot;Find matching AllowableFieldTypes&quot;&quot;&quot;</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_resolve_destination_to_inputs</span><span class="p">(</span><span class="n">destination</span><span class="p">)</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_resolve_source_to_outputs</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>

        <span class="n">matching_afts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">matching_inputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">matching_outputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
            <span class="k">for</span> <span class="nb">input</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
                <span class="n">io_matching_afts</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_find_matching_afts</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="nb">input</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">io_matching_afts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">input</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">matching_inputs</span><span class="p">:</span>
                        <span class="n">matching_inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">output</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">matching_outputs</span><span class="p">:</span>
                        <span class="n">matching_outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
                <span class="n">matching_afts</span> <span class="o">+=</span> <span class="n">io_matching_afts</span>
        <span class="k">return</span> <span class="n">matching_afts</span><span class="p">,</span> <span class="n">matching_inputs</span><span class="p">,</span> <span class="n">matching_outputs</span></div>

<div class="viewcode-block" id="Planner._find_matching_afts"><a class="viewcode-back" href="../../../developer/_autosummary/_autosummary/pydent.planner.planner.html#pydent.planner.planner.Planner._find_matching_afts">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_find_matching_afts</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Finds matching afts between two FieldValues&quot;&quot;&quot;</span>
        <span class="n">afts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">output_afts</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">field_type</span><span class="o">.</span><span class="n">allowable_field_types</span>
        <span class="n">input_afts</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">field_type</span><span class="o">.</span><span class="n">allowable_field_types</span>

        <span class="c1"># check whether the field_type handles collections</span>
        <span class="n">input_handles_collections</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">field_type</span><span class="o">.</span><span class="n">part</span> <span class="ow">is</span> <span class="kc">True</span>
        <span class="n">output_handles_collections</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">field_type</span><span class="o">.</span><span class="n">part</span> <span class="ow">is</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">input_handles_collections</span> <span class="o">!=</span> <span class="n">output_handles_collections</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">input_aft</span> <span class="ow">in</span> <span class="n">input_afts</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">output_aft</span> <span class="ow">in</span> <span class="n">output_afts</span><span class="p">:</span>
                <span class="n">out_object_type_id</span> <span class="o">=</span> <span class="n">output_aft</span><span class="o">.</span><span class="n">object_type_id</span>
                <span class="n">in_object_type_id</span> <span class="o">=</span> <span class="n">input_aft</span><span class="o">.</span><span class="n">object_type_id</span>
                <span class="n">out_sample_type_id</span> <span class="o">=</span> <span class="n">output_aft</span><span class="o">.</span><span class="n">sample_type_id</span>
                <span class="n">in_sample_type_id</span> <span class="o">=</span> <span class="n">input_aft</span><span class="o">.</span><span class="n">sample_type_id</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">out_object_type_id</span> <span class="o">==</span> <span class="n">in_object_type_id</span>
                        <span class="ow">and</span> <span class="n">out_sample_type_id</span> <span class="o">==</span> <span class="n">in_sample_type_id</span><span class="p">):</span>
                    <span class="n">afts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">output_aft</span><span class="p">,</span> <span class="n">input_aft</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">afts</span></div>

    <span class="k">def</span> <span class="nf">quick_create_operation_by_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">otname</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_operation_by_name</span><span class="p">(</span><span class="o">*</span><span class="n">otname</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_operation_by_name</span><span class="p">(</span><span class="n">otname</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">quick_create_and_wire</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">otname1</span><span class="p">,</span> <span class="n">otname2</span><span class="p">,</span> <span class="n">fvnames</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quick_create_operation_by_name</span><span class="p">(</span><span class="n">otname1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quick_create_operation_by_name</span><span class="p">(</span><span class="n">otname2</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">quick_wire_by_name</span><span class="p">(</span><span class="n">otname1</span><span class="p">,</span> <span class="n">otname2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_contains_op</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">op</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">operations</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plan_operation_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">operations</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">op</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">op</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">plan_operation_ids</span>

    <span class="nd">@plan_verification_wrapper</span>
    <span class="k">def</span> <span class="nf">_resolve_op</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_operation_by_name</span><span class="p">(</span><span class="n">op</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">category</span><span class="o">=</span><span class="n">op</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_operation_by_name</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">category</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">op</span>

<div class="viewcode-block" id="Planner.quick_create_chain"><a class="viewcode-back" href="../../../developer/_autosummary/_autosummary/pydent.planner.planner.html#pydent.planner.planner.Planner.quick_create_chain">[docs]</a>    <span class="k">def</span> <span class="nf">quick_create_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">op_or_otnames</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a chain of operations by *guessing* wires between operations</span>
<span class="sd">        based on the AllowableFieldTypes between the inputs and outputs of each</span>
<span class="sd">        operation type.</span>
<span class="sd">        Sample inputs and outputs will be set along the wire if possible.</span>

<span class="sd">        e.g.</span>

<span class="sd">        .. code::</span>

<span class="sd">            # create four new operations based on their OperationType names</span>
<span class="sd">            planner.quick_create_chain(&quot;Make PCR Fragment&quot;, &quot;Run Gel&quot;,</span>
<span class="sd">                                      &quot;Extract Gel Slice&quot;, &quot;Purify Gel Slice&quot;)</span>

<span class="sd">            # create four new operations based on their OperationType names by</span>
<span class="sd">            # finding OperationTypes only in the &quot;Cloning&quot; category</span>
<span class="sd">            planner.quick_create_chain(&quot;Make PCR Fragment&quot;, &quot;Run Gel&quot;,</span>
<span class="sd">                                      &quot;Extract Gel Slice&quot;, &quot;Purify Gel Slice&quot;,</span>
<span class="sd">                                      category=&quot;Cloning&quot;)</span>

<span class="sd">            # create four new operations based on their OperationType names by</span>
<span class="sd">            # finding OperationTypes only in the &quot;Cloning&quot; category,</span>
<span class="sd">            # except find &quot;Make PCR Fragment&quot; in the &quot;Cloning Sandbox&quot; category</span>
<span class="sd">            planner.quick_create_chain((&quot;Make PCR Fragment&quot;, &quot;Cloning Sandbox&quot;),</span>
<span class="sd">                                       &quot;Run Gel&quot;, &quot;Extract Gel Slice&quot;,</span>
<span class="sd">                                       &quot;Purify Gel Slice&quot;, category=&quot;Cloning&quot;)</span>

<span class="sd">            # create and wire new operations to an existing operations while</span>
<span class="sd">            # routing samples</span>
<span class="sd">            pcr_op = planner.create_operation_by_name(&quot;Make PCR Fragment&quot;)</span>
<span class="sd">            planner.set_field_value(pcr_op.outputs[0], sample=my_sample)</span>
<span class="sd">            new_ops = planner.quick_create_chain(pcr_op, &quot;Run Gel&quot;)</span>
<span class="sd">            run_gel = new_ops[1]</span>
<span class="sd">            planner.quick_create_chain(&quot;Pour Gel&quot;, run_gel)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">(</span><span class="s2">&quot;QUICK CREATE CHAIN </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">op_or_otnames</span><span class="p">))</span>
        <span class="n">ops</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_resolve_op</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">category</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">op_or_otnames</span><span class="p">]</span>
        <span class="c1"># self.browser.recursive_retrieve(</span>
        <span class="c1">#     ops, {</span>
        <span class="c1">#         &#39;operation_type&#39;: {</span>
        <span class="c1">#             &quot;field_types&quot;: &quot;allowable_field_types&quot;</span>
        <span class="c1">#         }</span>
        <span class="c1">#     }</span>
        <span class="c1"># )</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">op</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">ops</span> <span class="k">if</span> <span class="n">op</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Could not find some operations: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ops</span><span class="p">))</span>
        <span class="n">pairs</span> <span class="o">=</span> <span class="n">arr_to_pairs</span><span class="p">(</span><span class="n">ops</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">op1</span><span class="p">,</span> <span class="n">op2</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">quick_wire</span><span class="p">(</span><span class="n">op1</span><span class="p">,</span> <span class="n">op2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ops</span></div>

<div class="viewcode-block" id="Planner._select_empty_input_array"><a class="viewcode-back" href="../../../developer/_autosummary/_autosummary/pydent.planner.planner.html#pydent.planner.planner.Planner._select_empty_input_array">[docs]</a>    <span class="k">def</span> <span class="nf">_select_empty_input_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">fvname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Selects the first &#39;empty&#39; (i.e. field_values with no Sample set)</span>
<span class="sd">        field value in the :class:`FieldValue` array.</span>
<span class="sd">        Returns None if the FieldType is not an array. If there are no current</span>
<span class="sd">        &#39;empty&#39; field values, a new one is instantiated and returned.</span>

<span class="sd">        :param op: Operation</span>
<span class="sd">        :param fvname: FieldType/FieldValue name of the array</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">field_type</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">operation_type</span><span class="o">.</span><span class="n">field_type</span><span class="p">(</span><span class="n">fvname</span><span class="p">,</span> <span class="s1">&#39;input&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">field_type</span><span class="o">.</span><span class="n">array</span><span class="p">:</span>
            <span class="n">existing_fvs</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">input_array</span><span class="p">(</span><span class="n">fvname</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">fv</span> <span class="ow">in</span> <span class="n">existing_fvs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fv</span><span class="o">.</span><span class="n">sample</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_incoming_wires</span><span class="p">(</span><span class="n">fv</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">fv</span>
            <span class="n">fv</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">add_to_field_value_array</span><span class="p">(</span><span class="n">field_type</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;input&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">fv</span></div>

    <span class="c1"># TODO: way to select preference for afts in quick_wire?</span>
<div class="viewcode-block" id="Planner.quick_wire"><a class="viewcode-back" href="../../../developer/_autosummary/_autosummary/pydent.planner.planner.html#pydent.planner.planner.Planner.quick_wire">[docs]</a>    <span class="nd">@plan_verification_wrapper</span>
    <span class="k">def</span> <span class="nf">quick_wire</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param source: field_value or operation source</span>
<span class="sd">        :type source: FieldValue|Operation</span>
<span class="sd">        :param destination: field_value or operation destination</span>
<span class="sd">        :type destination: FieldValue|Operation</span>
<span class="sd">        :param strict: will raise error if there is is ambiguous wiring between the source and destination</span>
<span class="sd">        :type strict: bool</span>
<span class="sd">        :return: created wire</span>
<span class="sd">        :rtype: Wire</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">afts</span><span class="p">,</span> <span class="n">model_inputs</span><span class="p">,</span> <span class="n">model_outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_matching_afts</span><span class="p">(</span>
            <span class="n">source</span><span class="p">,</span> <span class="n">destination</span><span class="p">)</span>

        <span class="c1"># TODO: only if matching FVs are ambiguous raise Exception</span>
        <span class="c1"># TODO: automatically wire to empty FV if they are equivalent</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model_inputs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_outputs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">strict</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PlannerException</span><span class="p">(</span>
                <span class="s2">&quot;Cannot quick wire. Ambiguous wiring between inputs [</span><span class="si">{}</span><span class="s2">] for </span><span class="si">{}</span><span class="s2"> and outputs [</span><span class="si">{}</span><span class="s2">] for </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Instead, try to use `add_wire` method to wire together two FieldValues.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">fv</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">fv</span> <span class="ow">in</span> <span class="n">model_inputs</span><span class="p">]),</span>
                    <span class="n">model_inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">operation</span><span class="o">.</span><span class="n">operation_type</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">fv</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">fv</span> <span class="ow">in</span> <span class="n">model_outputs</span><span class="p">]),</span>
                    <span class="n">model_outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">operation</span><span class="o">.</span><span class="n">operation_type</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">afts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">aft1</span><span class="p">,</span> <span class="n">aft2</span> <span class="ow">in</span> <span class="n">afts</span><span class="p">:</span>

                <span class="n">input_ft</span> <span class="o">=</span> <span class="n">aft2</span><span class="o">.</span><span class="n">field_type</span>
                <span class="n">output_ft</span> <span class="o">=</span> <span class="n">aft1</span><span class="o">.</span><span class="n">field_type</span>

                <span class="c1"># input_fv = None</span>
                <span class="k">if</span> <span class="n">input_ft</span><span class="o">.</span><span class="n">array</span><span class="p">:</span>
                    <span class="n">input_fv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_empty_input_array</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="n">input_ft</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">input_fv</span> <span class="o">=</span> <span class="n">destination</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="n">input_ft</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">output_fv</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">output_ft</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_wire</span><span class="p">(</span><span class="n">output_fv</span><span class="p">,</span> <span class="n">input_fv</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">afts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PlannerException</span><span class="p">(</span>
                <span class="s2">&quot;Cannot quick wire. No possible wiring found between inputs [</span><span class="si">{}</span><span class="s2">] for </span><span class="si">{}</span><span class="s2"> and outputs [</span><span class="si">{}</span><span class="s2">] for </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">fv</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">fv</span> <span class="ow">in</span> <span class="n">model_inputs</span><span class="p">]),</span>
                    <span class="n">model_inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">operation</span><span class="o">.</span><span class="n">operation_type</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">fv</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">fv</span> <span class="ow">in</span> <span class="n">model_outputs</span><span class="p">]),</span>
                    <span class="n">model_outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">operation</span><span class="o">.</span><span class="n">operation_type</span><span class="o">.</span><span class="n">name</span><span class="p">))</span></div>

<div class="viewcode-block" id="Planner.quick_wire_by_name"><a class="viewcode-back" href="../../../developer/_autosummary/_autosummary/pydent.planner.planner.html#pydent.planner.planner.Planner.quick_wire_by_name">[docs]</a>    <span class="k">def</span> <span class="nf">quick_wire_by_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">otname1</span><span class="p">,</span> <span class="n">otname2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Wires together the last added operations.&quot;&quot;&quot;</span>
        <span class="n">op1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_operations_by_name</span><span class="p">(</span><span class="n">otname1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">op2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_operations_by_name</span><span class="p">(</span><span class="n">otname2</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">quick_wire</span><span class="p">(</span><span class="n">op1</span><span class="p">,</span> <span class="n">op2</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">clean_wires</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">wires_by_id</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">wire</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">wires</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">wire</span><span class="o">.</span><span class="n">source</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">wire</span><span class="o">.</span><span class="n">destination</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">_id</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wire</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">_primary_key</span><span class="p">,</span> <span class="n">wire</span><span class="o">.</span><span class="n">destination</span><span class="o">.</span><span class="n">_primary_key</span><span class="p">)</span>
                <span class="n">wires_by_id</span><span class="p">[</span><span class="n">_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">wire</span>
        <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">operations</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">fv</span> <span class="ow">in</span> <span class="n">op</span><span class="o">.</span><span class="n">field_values</span><span class="p">:</span>
                <span class="n">wires_as_source</span> <span class="o">=</span> <span class="n">fv</span><span class="o">.</span><span class="n">wires_as_source</span>
                <span class="n">wires_as_dest</span> <span class="o">=</span> <span class="n">fv</span><span class="o">.</span><span class="n">wires_as_dest</span>

                <span class="k">if</span> <span class="n">wires_as_source</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">wires_as_source</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">wires_as_dest</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">wires_as_dest</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="n">fv</span><span class="o">.</span><span class="n">wires_as_source</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">wires_as_source</span><span class="p">))</span>
                <span class="n">fv</span><span class="o">.</span><span class="n">wires_as_dest</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">wires_as_dest</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">wires</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">wires_by_id</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">remove_operations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ops</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clean_wires</span><span class="p">()</span>
        <span class="n">operations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">operations</span>
        <span class="n">wires</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">wires</span><span class="p">)</span>
        <span class="n">wires_to_remove</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">:</span>
            <span class="n">operations</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">fv</span> <span class="ow">in</span> <span class="n">op</span><span class="o">.</span><span class="n">field_values</span><span class="p">:</span>
                <span class="n">wires_to_remove</span> <span class="o">=</span> <span class="n">wires_to_remove</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">fv</span><span class="o">.</span><span class="n">wires_as_source</span><span class="p">))</span>
                <span class="n">wires_to_remove</span> <span class="o">=</span> <span class="n">wires_to_remove</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">fv</span><span class="o">.</span><span class="n">wires_as_dest</span><span class="p">))</span>

        <span class="n">wires</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">wires</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">wires_to_remove</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">operations</span> <span class="o">=</span> <span class="n">operations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">wires</span> <span class="o">=</span> <span class="n">wires</span>

    <span class="c1"># TODO: resolve afts if already set...</span>
    <span class="c1"># TODO: clean up _set_wire</span>
    <span class="k">def</span> <span class="nf">_set_wire</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_fv</span><span class="p">,</span> <span class="n">dest_fv</span><span class="p">,</span> <span class="n">preference</span><span class="o">=</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="n">setter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_incoming_wires</span><span class="p">(</span><span class="n">dest_fv</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PlannerException</span><span class="p">(</span><span class="s2">&quot;Cannot wire because </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2"> already has an incoming wire and inputs&quot;</span>
                                   <span class="s2">&quot; can only have one incoming wire. Please remove wire&quot;</span>
                                   <span class="s2">&quot; using &#39;canvas.remove_wire(src_fv, dest_fv)&#39; before setting.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dest_fv</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

        <span class="c1"># first collect any matching allowable field types between the field values</span>
        <span class="n">aft_pairs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_matching_afts</span><span class="p">(</span><span class="n">src_fv</span><span class="p">,</span> <span class="n">dest_fv</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aft_pairs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PlannerException</span><span class="p">(</span><span class="s2">&quot;Cannot wire </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2"> to </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2">. No allowable field types match.&quot;</span>
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">src_fv</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dest_fv</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

        <span class="c1"># select the first aft</span>
        <span class="n">default_aft_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">src_fv</span><span class="o">.</span><span class="n">allowable_field_type_id</span><span class="p">,</span> <span class="n">dest_fv</span><span class="o">.</span><span class="n">allowable_field_type_id</span><span class="p">]</span>
        <span class="n">pref_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">preference</span> <span class="o">==</span> <span class="s2">&quot;destination&quot;</span><span class="p">:</span>
            <span class="n">pref_index</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">selected_aft_pair</span> <span class="o">=</span> <span class="n">aft_pairs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">aft_pairs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pair</span><span class="p">[</span><span class="n">pref_index</span><span class="p">]</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">default_aft_ids</span><span class="p">[</span><span class="n">pref_index</span><span class="p">]:</span>
                <span class="n">selected_aft_pair</span> <span class="o">=</span> <span class="n">pair</span>
        <span class="k">assert</span> <span class="n">selected_aft_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">object_type_id</span> <span class="o">==</span> <span class="n">selected_aft_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">object_type_id</span>

        <span class="c1"># resolve sample</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="p">[</span><span class="n">src_fv</span><span class="o">.</span><span class="n">sample</span><span class="p">,</span> <span class="n">dest_fv</span><span class="o">.</span><span class="n">sample</span><span class="p">]</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">samples</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">setter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">setter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_field_value</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">selected_sample</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[</span><span class="n">pref_index</span><span class="p">]</span>

            <span class="c1"># filter afts by sample_type_id</span>
            <span class="n">aft_pairs</span> <span class="o">=</span> <span class="p">[</span><span class="n">aft</span> <span class="k">for</span> <span class="n">aft</span> <span class="ow">in</span> <span class="n">aft_pairs</span> <span class="k">if</span> <span class="n">aft</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sample_type_id</span> <span class="o">==</span>
                         <span class="n">selected_sample</span><span class="o">.</span><span class="n">sample_type_id</span><span class="p">]</span>
            <span class="n">selected_aft_pair</span> <span class="o">=</span> <span class="n">aft_pairs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aft_pairs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">PlannerException</span><span class="p">(</span><span class="s2">&quot;No allowable_field_types were found for FieldValues </span><span class="si">{}</span><span class="s2"> &amp; </span><span class="si">{}</span><span class="s2"> for&quot;</span>
                                       <span class="s2">&quot; Sample </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">src_fv</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dest_fv</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">selected_sample</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

            <span class="n">setter</span><span class="p">(</span><span class="n">src_fv</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="n">selected_sample</span><span class="p">)</span>
            <span class="n">setter</span><span class="p">(</span><span class="n">dest_fv</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="n">selected_sample</span><span class="p">)</span>

            <span class="k">assert</span> <span class="n">selected_aft_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sample_type_id</span> <span class="o">==</span> <span class="n">selected_aft_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sample_type_id</span>
            <span class="k">assert</span> <span class="n">selected_aft_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sample_type_id</span> <span class="o">==</span> <span class="n">src_fv</span><span class="o">.</span><span class="n">sample</span><span class="o">.</span><span class="n">sample_type_id</span>
            <span class="k">assert</span> <span class="n">selected_aft_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sample_type_id</span> <span class="o">==</span> <span class="n">dest_fv</span><span class="o">.</span><span class="n">sample</span><span class="o">.</span><span class="n">sample_type_id</span>

            <span class="c1"># set the sample (and allowable_field_type)</span>
            <span class="k">if</span> <span class="n">src_fv</span><span class="o">.</span><span class="n">sample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">dest_fv</span><span class="o">.</span><span class="n">sample</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">dest_fv</span><span class="o">.</span><span class="n">sample</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="n">src_fv</span><span class="o">.</span><span class="n">sample</span><span class="o">.</span><span class="n">id</span><span class="p">):</span>
                <span class="n">setter</span><span class="p">(</span>
                    <span class="n">dest_fv</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="n">src_fv</span><span class="o">.</span><span class="n">sample</span><span class="p">,</span> <span class="n">container</span><span class="o">=</span><span class="n">selected_aft_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">object_type</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">dest_fv</span><span class="o">.</span><span class="n">sample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">src_fv</span><span class="o">.</span><span class="n">sample</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">dest_fv</span><span class="o">.</span><span class="n">sample</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="n">src_fv</span><span class="o">.</span><span class="n">sample</span><span class="o">.</span><span class="n">id</span><span class="p">):</span>
                <span class="n">setter</span><span class="p">(</span>
                    <span class="n">src_fv</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="n">dest_fv</span><span class="o">.</span><span class="n">sample</span><span class="p">,</span> <span class="n">container</span><span class="o">=</span><span class="n">selected_aft_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">object_type</span><span class="p">)</span>

        <span class="n">setter</span><span class="p">(</span><span class="n">src_fv</span><span class="p">,</span> <span class="n">container</span><span class="o">=</span><span class="n">selected_aft_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">object_type</span><span class="p">)</span>
        <span class="n">setter</span><span class="p">(</span><span class="n">dest_fv</span><span class="p">,</span> <span class="n">container</span><span class="o">=</span><span class="n">selected_aft_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">object_type</span><span class="p">)</span>

<div class="viewcode-block" id="Planner.add_wire"><a class="viewcode-back" href="../../../developer/_autosummary/_autosummary/pydent.planner.planner.html#pydent.planner.planner.Planner.add_wire">[docs]</a>    <span class="nd">@plan_verification_wrapper</span>
    <span class="k">def</span> <span class="nf">add_wire</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fv1</span><span class="p">,</span> <span class="n">fv2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Note that fv2.operation will not inherit parent_id of fv1&quot;&quot;&quot;</span>
        <span class="n">wire</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_wire</span><span class="p">(</span><span class="n">fv1</span><span class="p">,</span> <span class="n">fv2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">wire</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># wire does not exist, so create it</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_wire</span><span class="p">(</span><span class="n">fv1</span><span class="p">,</span> <span class="n">fv2</span><span class="p">)</span>
            <span class="n">wire</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">wire</span><span class="p">(</span><span class="n">fv1</span><span class="p">,</span> <span class="n">fv2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">(</span><span class="s2">&quot;wired </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fv1</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">fv2</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">wire</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_routing_id</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">fv</span><span class="p">):</span>
        <span class="n">routing_id</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_id_getter</span><span class="p">(</span><span class="n">fv</span><span class="o">.</span><span class="n">operation</span><span class="p">),</span> <span class="n">fv</span><span class="o">.</span><span class="n">field_type</span><span class="o">.</span><span class="n">routing</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fv</span><span class="o">.</span><span class="n">field_type</span><span class="o">.</span><span class="n">array</span> <span class="ow">and</span> <span class="n">fv</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;input&quot;</span><span class="p">:</span>
            <span class="n">other_fvs</span> <span class="o">=</span> <span class="n">fv</span><span class="o">.</span><span class="n">operation</span><span class="o">.</span><span class="n">input_array</span><span class="p">(</span><span class="n">fv</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">other_fv</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">other_fvs</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">models_are_equal</span><span class="p">(</span><span class="n">other_fv</span><span class="p">,</span> <span class="n">fv</span><span class="p">):</span>
                    <span class="n">routing_id</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">routing_id</span>
        <span class="k">return</span> <span class="n">routing_id</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_routing_dict</span><span class="p">(</span><span class="n">op</span><span class="p">):</span>
        <span class="n">routing_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">fv</span> <span class="ow">in</span> <span class="n">op</span><span class="o">.</span><span class="n">field_values</span><span class="p">:</span>
            <span class="n">routing</span> <span class="o">=</span> <span class="n">fv</span><span class="o">.</span><span class="n">field_type</span><span class="o">.</span><span class="n">routing</span>
            <span class="n">routing_fvs</span> <span class="o">=</span> <span class="n">routing_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">routing</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">routing_fvs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fv</span><span class="p">)</span>
            <span class="n">routing_dict</span><span class="p">[</span><span class="n">fv</span><span class="o">.</span><span class="n">field_type</span><span class="o">.</span><span class="n">routing</span><span class="p">]</span> <span class="o">=</span> <span class="n">routing_fvs</span>
        <span class="k">return</span> <span class="n">routing_dict</span>

<div class="viewcode-block" id="Planner._routing_graph"><a class="viewcode-back" href="../../../developer/_autosummary/_autosummary/pydent.planner.planner.html#pydent.planner.planner.Planner._routing_graph">[docs]</a>    <span class="k">def</span> <span class="nf">_routing_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get sample routing graph. A property of a valid plan is that any two routing nodes</span>
<span class="sd">        that are connected by an edge must have the same sample. Edges are treated as &#39;sample wires&#39;&quot;&quot;&quot;</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">operations</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">fv</span> <span class="ow">in</span> <span class="n">op</span><span class="o">.</span><span class="n">field_values</span><span class="p">:</span>
                <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_routing_id</span><span class="p">(</span><span class="n">fv</span><span class="p">),</span> <span class="n">fv</span><span class="o">=</span><span class="n">fv</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">wires</span><span class="p">:</span>
            <span class="n">src_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_routing_id</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
            <span class="n">dest_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_routing_id</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">destination</span><span class="p">)</span>

            <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">src_id</span><span class="p">,</span> <span class="n">fv</span><span class="o">=</span><span class="n">w</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
            <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">dest_id</span><span class="p">,</span> <span class="n">fv</span><span class="o">=</span><span class="n">w</span><span class="o">.</span><span class="n">destination</span><span class="p">)</span>

            <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">src_id</span><span class="p">,</span> <span class="n">dest_id</span><span class="p">,</span> <span class="n">wire</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">G</span></div>

    <span class="c1"># TODO: Support for row and column</span>
    <span class="c1"># TODO: routing dict does not work with input arrays (it groups them ALL together)</span>
    <span class="nd">@plan_verification_wrapper</span>
    <span class="k">def</span> <span class="nf">set_field_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_value</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">container</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">(</span>
            <span class="s2">&quot;setting field_value </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2"> - </span><span class="si">{}</span><span class="s2"> - </span><span class="si">{}</span><span class="s2"> - </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field_value</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">container</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="n">field_value</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span>
            <span class="n">sample</span><span class="o">=</span><span class="n">sample</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="n">item</span><span class="p">,</span> <span class="n">container</span><span class="o">=</span><span class="n">container</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">field_value</span><span class="o">.</span><span class="n">field_type</span><span class="o">.</span><span class="n">array</span><span class="p">:</span>
            <span class="n">routing</span> <span class="o">=</span> <span class="n">field_value</span><span class="o">.</span><span class="n">field_type</span><span class="o">.</span><span class="n">routing</span>
            <span class="n">fvs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_routing_dict</span><span class="p">(</span><span class="n">field_value</span><span class="o">.</span><span class="n">operation</span><span class="p">)[</span><span class="n">routing</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">field_value</span><span class="o">.</span><span class="n">field_type</span><span class="o">.</span><span class="n">ftype</span> <span class="o">==</span> <span class="s1">&#39;sample&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">fv</span> <span class="ow">in</span> <span class="n">fvs</span><span class="p">:</span>
                    <span class="n">fv</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">sample</span><span class="o">=</span><span class="n">sample</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">field_value</span>

<div class="viewcode-block" id="Planner.set_input_field_value_array"><a class="viewcode-back" href="../../../developer/_autosummary/_autosummary/pydent.planner.planner.html#pydent.planner.planner.Planner.set_input_field_value_array">[docs]</a>    <span class="k">def</span> <span class="nf">set_input_field_value_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">field_value_name</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">container</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finds the first &#39;empty&#39; (no incoming wires and no sample set) field value and set the field value.</span>
<span class="sd">        If there are no empty field values in the array, create a new field value and set that one.</span>

<span class="sd">        :param op: operation</span>
<span class="sd">        :type op: Operation</span>
<span class="sd">        :param field_value_name: field value name</span>
<span class="sd">        :type field_value_name: basestring</span>
<span class="sd">        :param sample: the sample to set</span>
<span class="sd">        :type sample: Sample</span>
<span class="sd">        :param item: the item to set</span>
<span class="sd">        :type item: Item</span>
<span class="sd">        :param container: the container type to set</span>
<span class="sd">        :type container: ObjectType</span>
<span class="sd">        :return: the set field value</span>
<span class="sd">        :rtype: FieldValue</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">input_fv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_empty_input_array</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">field_value_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_field_value</span><span class="p">(</span><span class="n">input_fv</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="n">sample</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="n">item</span><span class="p">,</span> <span class="n">container</span><span class="o">=</span><span class="n">container</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">set_field_value_and_propogate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_value</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># ots = self.browser.where(&#39;OperationType&#39;, {&quot;id&quot;: [op.operation_type_id for op in self.plan.operations]})</span>
        <span class="c1"># self.browser.retrieve(ots, &#39;field_types&#39;)</span>
        <span class="n">routing_graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_routing_graph</span><span class="p">()</span>
        <span class="n">routing_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_routing_id</span><span class="p">(</span><span class="n">field_value</span><span class="p">)</span>
        <span class="n">subgraph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">bfs_tree</span><span class="p">(</span><span class="n">routing_graph</span><span class="o">.</span><span class="n">to_undirected</span><span class="p">(),</span> <span class="n">routing_id</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">subgraph</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">routing_graph</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">node</span><span class="p">]</span>
            <span class="n">fv</span> <span class="o">=</span> <span class="n">n</span><span class="p">[</span><span class="s1">&#39;fv&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_field_value</span><span class="p">(</span><span class="n">fv</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="n">sample</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">field_value</span>

    <span class="nd">@staticmethod</span>
    <span class="nd">@make_async</span>
    <span class="k">def</span> <span class="nf">_filter_by_lambdas</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">lambda_arr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Filters models by a array of lambdas.&quot;&quot;&quot;</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">models</span><span class="p">[:]</span>
        <span class="n">_arr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="n">arr</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">fxn</span> <span class="ow">in</span> <span class="n">lambda_arr</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">fxn</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
                        <span class="n">_arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">TypeError</span> <span class="ow">or</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">continue</span>
        <span class="k">return</span> <span class="n">_arr</span>

    <span class="k">def</span> <span class="nf">_item_preference_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">field_value</span><span class="p">,</span> <span class="n">item_preference</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">item_preference</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ITEM_SELECTION_PREFERENCE</span><span class="o">.</span><span class="n">_CHOICES</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PlannerException</span><span class="p">(</span><span class="s2">&quot;Item selection preference </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2"> not recognized&quot;</span>
                                   <span class="s2">&quot; Please select from one of </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item_preference</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ITEM_SELECTION_PREFERENCE</span><span class="o">.</span><span class="n">_CHOICES</span><span class="p">)))</span>
        <span class="n">query</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;sample_id&quot;</span><span class="p">:</span> <span class="n">sample</span><span class="o">.</span><span class="n">id</span><span class="p">}</span>

        <span class="c1"># restrict allowable_field_types based on preference</span>
        <span class="n">afts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">field_value</span><span class="o">.</span><span class="n">field_type</span><span class="o">.</span><span class="n">allowable_field_types</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">item_preference</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ITEM_SELECTION_PREFERENCE</span><span class="o">.</span><span class="n">RESTRICT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ITEM_SELECTION_PREFERENCE</span><span class="o">.</span><span class="n">RESTRICT_TO_ONE</span><span class="p">]:</span>
            <span class="n">afts</span> <span class="o">=</span> <span class="p">[</span><span class="n">field_value</span><span class="o">.</span><span class="n">allowable_field_type</span><span class="p">]</span>
        <span class="c1"># elif item_preference in [self.ITEM_SELECTION_PREFERENCE.ANY, self.ITEM_SELECTION_PREFERENCE.PREFERRED]:</span>
        <span class="c1">#     afts = [aft for aft in field_value.field_type.allowable_field_types if aft.sample]</span>
        <span class="k">if</span> <span class="n">item_preference</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ITEM_SELECTION_PREFERENCE</span><span class="o">.</span><span class="n">PREFERRED</span><span class="p">:</span>
            <span class="n">afts</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">afts</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">aft</span><span class="p">:</span> <span class="n">aft</span><span class="o">.</span><span class="n">sample_type_id</span> <span class="o">==</span> <span class="n">sample</span><span class="o">.</span><span class="n">sample_type_id</span><span class="p">)</span>

        <span class="n">query</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;object_type_id&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">aft</span><span class="o">.</span><span class="n">object_type_id</span> <span class="k">for</span> <span class="n">aft</span> <span class="ow">in</span> <span class="n">afts</span><span class="p">]})</span>
        <span class="k">return</span> <span class="n">query</span>

<div class="viewcode-block" id="Planner.reserved_items"><a class="viewcode-back" href="../../../developer/_autosummary/_autosummary/pydent.planner.planner.html#pydent.planner.planner.Planner.reserved_items">[docs]</a>    <span class="k">def</span> <span class="nf">reserved_items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a dictionary of item_ids and the array of field_values that use them&quot;&quot;&quot;</span>
        <span class="n">browser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_browser</span>
        <span class="n">item_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">items</span><span class="p">]</span>
        <span class="n">server_fvs</span> <span class="o">=</span> <span class="n">browser</span><span class="o">.</span><span class="n">where</span><span class="p">({</span><span class="s2">&quot;child_item_id&quot;</span><span class="p">:</span> <span class="n">item_ids</span><span class="p">},</span> <span class="n">model_class</span><span class="o">=</span><span class="s1">&#39;FieldValue&#39;</span><span class="p">)</span>
        <span class="n">browser</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">server_fvs</span><span class="p">,</span> <span class="s1">&#39;operation&#39;</span><span class="p">)</span>
        <span class="n">server_fvs</span> <span class="o">=</span> <span class="p">[</span><span class="n">fv</span> <span class="k">for</span> <span class="n">fv</span> <span class="ow">in</span> <span class="n">server_fvs</span> <span class="k">if</span> <span class="n">fv</span><span class="o">.</span><span class="n">operation</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="s1">&#39;planning&#39;</span><span class="p">]</span>

        <span class="n">these_fvs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">operations</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">fv</span> <span class="ow">in</span> <span class="n">op</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fv</span><span class="o">.</span><span class="n">child_item_id</span> <span class="ow">in</span> <span class="n">item_ids</span><span class="p">:</span>
                    <span class="n">these_fvs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fv</span><span class="p">)</span>

        <span class="n">fvs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">server_fvs</span> <span class="o">+</span> <span class="n">these_fvs</span><span class="p">))</span>

        <span class="n">item_id_to_fv</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fv</span> <span class="ow">in</span> <span class="n">fvs</span><span class="p">:</span>
            <span class="n">item_id_to_fv</span><span class="p">[</span><span class="n">fv</span><span class="o">.</span><span class="n">child_item_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fv</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">item_id_to_fv</span></div>

    <span class="nd">@plan_verification_wrapper</span>
    <span class="k">def</span> <span class="nf">get_available_items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_value</span><span class="p">,</span> <span class="n">item_preference</span><span class="p">):</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="n">field_value</span><span class="o">.</span><span class="n">sample</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sample</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_item_preference_query</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">field_value</span><span class="p">,</span> <span class="n">item_preference</span><span class="p">)</span>
        <span class="n">available_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">Item</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">available_items</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">available_items</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">location</span> <span class="o">!=</span> <span class="s1">&#39;deleted&#39;</span><span class="p">]</span>


        <span class="n">x</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">available_items</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">item_preference</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ITEM_SELECTION_PREFERENCE</span><span class="o">.</span><span class="n">RESTRICT_TO_ONE</span><span class="p">:</span>
            <span class="n">reserved</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reserved_items</span><span class="p">(</span><span class="n">available_items</span><span class="p">)</span>
            <span class="n">available_items</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">available_items</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">reserved</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">id</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> items are reserved&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">available_items</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">available_items</span>

<div class="viewcode-block" id="Planner.distribute_items_of_object_type"><a class="viewcode-back" href="../../../developer/_autosummary/_autosummary/pydent.planner.planner.html#pydent.planner.planner.Planner.distribute_items_of_object_type">[docs]</a>    <span class="k">def</span> <span class="nf">distribute_items_of_object_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">object_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Distribute items of a particular object_type across non-planning operations across</span>
<span class="sd">         existing plans and these operations in this Planner instance. E.g. distributing</span>
<span class="sd">         one-shot yeast competent cell aliquots&quot;&quot;&quot;</span>
        <span class="c1"># collect items of that type used</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">browser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_browser</span>
        <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">operations</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">op</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">item</span>
                <span class="k">if</span> <span class="n">item</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">object_type_id</span> <span class="o">==</span> <span class="n">object_type</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
                        <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

        <span class="c1"># find all field_values that use this item</span>
        <span class="n">item_id_to_fv</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">item_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">items</span><span class="p">]</span>
        <span class="n">fvs</span> <span class="o">=</span> <span class="n">browser</span><span class="o">.</span><span class="n">where</span><span class="p">({</span><span class="s2">&quot;child_item_id&quot;</span><span class="p">:</span> <span class="n">item_ids</span><span class="p">},</span> <span class="n">model_class</span><span class="o">=</span><span class="s1">&#39;FieldValue&#39;</span><span class="p">)</span>
        <span class="n">browser</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">fvs</span><span class="p">,</span> <span class="s1">&#39;operation&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">fv</span> <span class="ow">in</span> <span class="n">fvs</span><span class="p">:</span>
            <span class="n">item_id_to_fv</span><span class="p">[</span><span class="n">fv</span><span class="o">.</span><span class="n">child_item_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fv</span><span class="p">)</span>

        <span class="n">distributed</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="n">fvs</span> <span class="o">=</span> <span class="n">item_id_to_fv</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>

            <span class="c1"># filter by operations that are submitted</span>
            <span class="n">fvs</span> <span class="o">=</span> <span class="p">[</span><span class="n">fv</span> <span class="k">for</span> <span class="n">fv</span> <span class="ow">in</span> <span class="n">fvs</span> <span class="k">if</span> <span class="n">fv</span><span class="o">.</span><span class="n">operation</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="s1">&#39;planning&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fvs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">available_items</span> <span class="o">=</span> <span class="n">browser</span><span class="o">.</span><span class="n">where</span><span class="p">({</span><span class="s2">&quot;sample_id&quot;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">sample_id</span><span class="p">,</span> <span class="s1">&#39;object_type_id&#39;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">object_type_id</span><span class="p">},</span>
                                                <span class="n">model_class</span><span class="o">=</span><span class="s1">&#39;Item&#39;</span><span class="p">)</span>
                <span class="n">available_items</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">available_items</span> <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">location</span> <span class="o">!=</span> <span class="s1">&#39;deleted&#39;</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Item </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> is used in </span><span class="si">{}</span><span class="s2"> inputs. There are </span><span class="si">{}</span><span class="s2"> available items.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">sample</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                                                              <span class="nb">len</span><span class="p">(</span><span class="n">fvs</span><span class="p">),</span>
                                                                                              <span class="nb">len</span><span class="p">(</span><span class="n">available_items</span><span class="p">)))</span>

                <span class="k">for</span> <span class="n">fv</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">zip_longest</span><span class="p">(</span><span class="n">fvs</span><span class="p">,</span> <span class="n">available_items</span><span class="p">,</span> <span class="n">fillvalue</span><span class="o">=</span><span class="s1">&#39;&amp;&amp;&amp;&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">fv</span> <span class="o">!=</span> <span class="s1">&#39;&amp;&amp;&amp;&#39;</span> <span class="ow">and</span> <span class="n">item</span> <span class="o">!=</span> <span class="s1">&#39;&amp;&amp;&amp;&#39;</span><span class="p">:</span>
                        <span class="n">distributed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fv</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">fv</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">distributed</span><span class="p">:</span>
            <span class="n">fv</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="n">item</span><span class="p">)</span></div>

<div class="viewcode-block" id="Planner.set_to_available_item"><a class="viewcode-back" href="../../../developer/_autosummary/_autosummary/pydent.planner.planner.html#pydent.planner.planner.Planner.set_to_available_item">[docs]</a>    <span class="nd">@plan_verification_wrapper</span>
    <span class="k">def</span> <span class="nf">set_to_available_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fv</span><span class="p">,</span> <span class="n">order_preference</span><span class="o">=</span><span class="n">ITEM_ORDER_PREFERENCE</span><span class="o">.</span><span class="n">_DEFAULT</span><span class="p">,</span> <span class="n">filter_func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">item_preference</span><span class="o">=</span><span class="n">ITEM_SELECTION_PREFERENCE</span><span class="o">.</span><span class="n">_DEFAULT</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the item of the field value to the next available item. Setting recent=False will select</span>
<span class="sd">        the oldest item.</span>

<span class="sd">        :param fv: The field value to set.</span>
<span class="sd">        :type fv: FieldValue</span>
<span class="sd">        :param recent: whether to select the most recent item (recent=True is default)</span>
<span class="sd">        :type recent: bool</span>
<span class="sd">        :param filter_func: array of lambda to filter items by. E.g. &#39;lambda_arr=[lambda x: x.get(&quot;concentration&quot;) &gt; 10]&#39;</span>
<span class="sd">        :type filter_func: list</span>
<span class="sd">        :param order_preference: The item order preference. Select from &quot;LAST&quot; (default), &quot;FIRST&quot;, or &quot;RANDOM&quot;. Selections</span>
<span class="sd">                                also available in :class:`Planner.ITEM_ORDER_PREFERENCE`. Random will choose a random item</span>
<span class="sd">                                from the available items found after all preferences and filters</span>
<span class="sd">        :type order_preference: basestring</span>
<span class="sd">        :param item_preference: The item selection preference. Select from items in :class:`Planner.ITEM_SELECTION_PREFERENCE`</span>
<span class="sd">                                If &quot;PREFERRED&quot; (default), will select item that matches the allowable_field_value that is</span>
<span class="sd">                                already set for the field_value, else select any item that matches the :class:`Sample` set :class:`FieldValue`. If</span>
<span class="sd">                                &quot;RESTRICT&quot;, will restrict selected item only to those that matches the current allowable_field_value</span>
<span class="sd">                                that is set for the :class:`FieldValue`. If &quot;ANY&quot;, will select any items that matches the :class:`Sample`.</span>
<span class="sd">                                set for the field_value</span>
<span class="sd">        :type item_preference: basestring</span>
<span class="sd">        :return: The selected item (or None if no item set)</span>
<span class="sd">        :rtype: Item or None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="n">fv</span><span class="o">.</span><span class="n">sample</span>
        <span class="n">item</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">sample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">available_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_available_items</span><span class="p">(</span><span class="n">fv</span><span class="p">,</span> <span class="n">item_preference</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">filter_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filter_func</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">filter_func</span> <span class="o">=</span> <span class="p">[</span><span class="n">filter_func</span><span class="p">]</span>
                <span class="n">available_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_by_lambdas</span><span class="p">(</span><span class="n">available_items</span><span class="p">,</span> <span class="n">filter_func</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">available_items</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="n">available_items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">available_items</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span>

            <span class="n">selection_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">order_preference</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ITEM_ORDER_PREFERENCE</span><span class="o">.</span><span class="n">FIRST</span><span class="p">:</span>
                <span class="n">selection_index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="n">order_preference</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ITEM_ORDER_PREFERENCE</span><span class="o">.</span><span class="n">LAST</span><span class="p">:</span>
                <span class="n">selection_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">elif</span> <span class="n">order_preference</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ITEM_ORDER_PREFERENCE</span><span class="o">.</span><span class="n">RANDOM</span><span class="p">:</span>
                <span class="n">selection_index</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">available_items</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">available_items</span><span class="p">[</span><span class="n">selection_index</span><span class="p">]</span>
            <span class="n">fv</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="n">item</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">item</span></div>

<div class="viewcode-block" id="Planner.set_inputs_with_sample"><a class="viewcode-back" href="../../../developer/_autosummary/_autosummary/pydent.planner.planner.html#pydent.planner.planner.Planner.set_inputs_with_sample">[docs]</a>    <span class="nd">@plan_verification_wrapper</span>
    <span class="k">def</span> <span class="nf">set_inputs_with_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">routing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">setter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Map the sample field values to the operation inputs. Optionally, a routing dictionary may</span>
<span class="sd">        be passed to indicate the mapping between the sample field values and operation inputs.</span>

<span class="sd">        For example, the following would map the &quot;Integrant&quot; sample field value to the &quot;Template&quot;</span>
<span class="sd">        operation input, and so on...:</span>

<span class="sd">        .. code:: python</span>

<span class="sd">            routing={</span>
<span class="sd">                &quot;Integrant&quot;: &quot;Template&quot;,</span>
<span class="sd">                &quot;QC_Primer1&quot;: &quot;Forward Primer&quot;,</span>
<span class="sd">                &quot;QC_Primer2&quot;: &quot;Reverse Primer&quot;</span>
<span class="sd">            }</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">routing</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">routing</span> <span class="o">=</span> <span class="p">{</span><span class="n">ft</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">ft</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">ft</span> <span class="ow">in</span> <span class="n">sample</span><span class="o">.</span><span class="n">sample_type</span><span class="o">.</span><span class="n">field_types</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">setter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">setter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_field_value</span>
        <span class="k">for</span> <span class="n">sfv</span><span class="p">,</span> <span class="n">ofv</span> <span class="ow">in</span> <span class="n">routing</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">operation_input</span> <span class="o">=</span> <span class="n">operation</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="n">ofv</span><span class="p">)</span>
            <span class="n">sample_property</span> <span class="o">=</span> <span class="n">sample</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sfv</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="c1"># set operation input to the property sample</span>
            <span class="k">if</span> <span class="n">operation_input</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sample_property</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">setter</span><span class="p">(</span><span class="n">operation_input</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="n">sample_property</span><span class="p">)</span></div>

<div class="viewcode-block" id="Planner.set_output"><a class="viewcode-back" href="../../../developer/_autosummary/_autosummary/pydent.planner.planner.html#pydent.planner.planner.Planner.set_output">[docs]</a>    <span class="nd">@plan_verification_wrapper</span>
    <span class="k">def</span> <span class="nf">set_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fv</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">routing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">setter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the output of the field value to the sample. If the field_value names between the Sample and</span>
<span class="sd">        the field_value&#39;s operation inputs, these will be set as well. Optionally, a routing dictionary may</span>
<span class="sd">        be passed to indicate the mapping between the sample field values and the operation field values.</span>

<span class="sd">        :param fv: the output field value</span>
<span class="sd">        :type fv:</span>
<span class="sd">        :param sample:</span>
<span class="sd">        :type sample:</span>
<span class="sd">        :param routing:</span>
<span class="sd">        :type routing:</span>
<span class="sd">        :return:</span>
<span class="sd">        :rtype:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">fv</span><span class="o">.</span><span class="n">role</span> <span class="o">!=</span> <span class="s2">&quot;output&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Cannot output. FieldValue </span><span class="si">{}</span><span class="s2"> is a/an </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fv</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">fv</span><span class="o">.</span><span class="n">role</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">setter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">setter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_field_value</span>
        <span class="n">setter</span><span class="p">(</span><span class="n">fv</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="n">sample</span><span class="p">)</span>
        <span class="n">op</span> <span class="o">=</span> <span class="n">fv</span><span class="o">.</span><span class="n">operation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_inputs_with_sample</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">routing</span><span class="o">=</span><span class="n">routing</span><span class="p">,</span> <span class="n">setter</span><span class="o">=</span><span class="n">setter</span><span class="p">)</span></div>

<div class="viewcode-block" id="Planner._json_update"><a class="viewcode-back" href="../../../developer/_autosummary/_autosummary/pydent.planner.planner.html#pydent.planner.planner.Planner._json_update">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_json_update</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Temporary method to update&quot;&quot;&quot;</span>
        <span class="n">aqhttp</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_AqSession__aqhttp</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">}}</span>
        <span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">))</span>
        <span class="n">model_data</span> <span class="o">=</span> <span class="n">aqhttp</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;json/save&#39;</span><span class="p">,</span> <span class="n">json_data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">reload</span><span class="p">(</span><span class="n">model_data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">move_operation</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">plan_id</span><span class="p">):</span>
        <span class="n">pa</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">plan_associations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">pa</span><span class="o">.</span><span class="n">plan_id</span> <span class="o">=</span> <span class="n">plan_id</span>
        <span class="n">op</span><span class="o">.</span><span class="n">parent_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_json_update</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_json_update</span><span class="p">(</span><span class="n">pa</span><span class="p">)</span>

<div class="viewcode-block" id="Planner.find_operations_by_name"><a class="viewcode-back" href="../../../developer/_autosummary/_autosummary/pydent.planner.planner.html#pydent.planner.planner.Planner.find_operations_by_name">[docs]</a>    <span class="k">def</span> <span class="nf">find_operations_by_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operation_type_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find operations by their operation_type_name</span>

<span class="sd">        :param operation_type_name: The operation type name</span>
<span class="sd">        :type operation_type_name: basestring</span>
<span class="sd">        :return: list of operations</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">op</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">operations</span> <span class="k">if</span>
                <span class="n">op</span><span class="o">.</span><span class="n">operation_type</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">operation_type_name</span><span class="p">]</span></div>

    <span class="k">def</span> <span class="nf">find_operation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opid</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">operations</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">_primary_key</span> <span class="o">==</span> <span class="n">opid</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">op</span>

<div class="viewcode-block" id="Planner.replan"><a class="viewcode-back" href="../../../developer/_autosummary/_autosummary/pydent.planner.planner.html#pydent.planner.planner.Planner.replan">[docs]</a>    <span class="k">def</span> <span class="nf">replan</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Replan the plan, by &#39;copying&#39; the plan using the Aquarium server.&quot;&quot;&quot;</span>
        <span class="n">planner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>
        <span class="n">planner</span><span class="o">.</span><span class="n">plan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">replan</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">planner</span></div>

<div class="viewcode-block" id="Planner.annotate"><a class="viewcode-back" href="../../../developer/_autosummary/_autosummary/pydent.planner.planner.html#pydent.planner.planner.Planner.annotate">[docs]</a>    <span class="k">def</span> <span class="nf">annotate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">markdown</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Annotates the plan with Markdown text.</span>

<span class="sd">        :param markdown: text to annotate (in markdown format)</span>
<span class="sd">        :type markdown: basestring</span>
<span class="sd">        :param x: x-position</span>
<span class="sd">        :type x: int</span>
<span class="sd">        :param y: y-position</span>
<span class="sd">        :type y: int</span>
<span class="sd">        :param width: width of the text box</span>
<span class="sd">        :type width: int</span>
<span class="sd">        :param height: height of the text box</span>
<span class="sd">        :type height: int</span>
<span class="sd">        :return: None</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">annotation</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;anchor&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">width</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">height</span><span class="p">},</span>
            <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span>
            <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">y</span><span class="p">,</span>
            <span class="s2">&quot;markdown&quot;</span><span class="p">:</span> <span class="n">markdown</span>
        <span class="p">}</span>
        <span class="n">markdown</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&lt;!-- annotated by pydent.planner --&gt;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;text_boxes&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s1">&#39;text_boxes&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s1">&#39;text_boxes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">annotation</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s1">&#39;text_boxes&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s1">&#39;text_boxes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">annotation</span></div>

<div class="viewcode-block" id="Planner.annotate_operations"><a class="viewcode-back" href="../../../developer/_autosummary/_autosummary/pydent.planner.planner.html#pydent.planner.planner.Planner.annotate_operations">[docs]</a>    <span class="k">def</span> <span class="nf">annotate_operations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span> <span class="n">markdown</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Annotates above the operations. Estimates the x-midpoint and y and makes a</span>
<span class="sd">        text annotation at that location.&quot;&quot;&quot;</span>
        <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">ops_to_layout</span><span class="p">(</span><span class="n">ops</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotate_above_layout</span><span class="p">(</span><span class="n">markdown</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="n">layout</span><span class="p">)</span></div>

<div class="viewcode-block" id="Planner.annotate_above_layout"><a class="viewcode-back" href="../../../developer/_autosummary/_autosummary/pydent.planner.planner.html#pydent.planner.planner.Planner.annotate_above_layout">[docs]</a>    <span class="k">def</span> <span class="nf">annotate_above_layout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">markdown</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Annotates text directly above a layout&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">layout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layout</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">midpoint</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">layout</span><span class="o">.</span><span class="n">BOX_WIDTH</span> <span class="o">/</span> <span class="mi">2</span>  <span class="c1"># adjust so x is midpoint of &#39;box&#39; on screen</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">y</span>

        <span class="c1"># center the annotation</span>
        <span class="n">x</span> <span class="o">-=</span> <span class="n">width</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">y</span> <span class="o">-=</span> <span class="n">height</span>

        <span class="c1"># give some space between annotation and operation</span>
        <span class="n">y</span> <span class="o">-=</span> <span class="n">layout</span><span class="o">.</span><span class="n">BOX_DELTA_Y</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">markdown</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">layout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">PlannerLayout</span><span class="o">.</span><span class="n">from_plan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_fv_to_hash</span><span class="p">(</span><span class="n">fv</span><span class="p">,</span> <span class="n">ft</span><span class="p">):</span>
        <span class="c1"># none valued Samples are never equivalent</span>
        <span class="n">sid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">fv</span><span class="o">.</span><span class="n">sample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sid</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fv</span><span class="o">.</span><span class="n">role</span><span class="p">,</span> <span class="n">fv</span><span class="o">.</span><span class="n">sample</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="n">item_id</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>
        <span class="k">if</span> <span class="n">fv</span><span class="o">.</span><span class="n">item</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">item_id</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fv</span><span class="o">.</span><span class="n">role</span><span class="p">,</span> <span class="n">fv</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">fvhash</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">ft</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ft</span><span class="o">.</span><span class="n">role</span><span class="p">,</span> <span class="n">sid</span><span class="p">,</span> <span class="n">item_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ft</span><span class="o">.</span><span class="n">part</span><span class="p">:</span>
            <span class="n">fvhash</span> <span class="o">+=</span> <span class="s2">&quot;r</span><span class="si">{row}</span><span class="s2">:c</span><span class="si">{column}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">row</span><span class="o">=</span><span class="n">fv</span><span class="o">.</span><span class="n">row</span><span class="p">,</span>
                <span class="n">column</span><span class="o">=</span><span class="n">fv</span><span class="o">.</span><span class="n">column</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">fvhash</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_fv_array_to_hash</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">fv_array</span><span class="p">,</span> <span class="n">ft</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;*&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">cls</span><span class="o">.</span><span class="n">_fv_to_hash</span><span class="p">(</span><span class="n">fv</span><span class="p">,</span> <span class="n">ft</span><span class="p">)</span> <span class="k">for</span> <span class="n">fv</span> <span class="ow">in</span> <span class="n">fv_array</span><span class="p">])</span>

<div class="viewcode-block" id="Planner._op_to_hash"><a class="viewcode-back" href="../../../developer/_autosummary/_autosummary/pydent.planner.planner.html#pydent.planner.planner.Planner._op_to_hash">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_op_to_hash</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">op</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Turns a operation into a hash using the operation_type_id, item_id, and sample_id&quot;&quot;&quot;</span>
        <span class="n">ot_id</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">operation_type</span><span class="o">.</span><span class="n">id</span>

        <span class="n">field_type_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ft</span> <span class="ow">in</span> <span class="n">op</span><span class="o">.</span><span class="n">operation_type</span><span class="o">.</span><span class="n">field_types</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ft</span><span class="o">.</span><span class="n">ftype</span> <span class="o">==</span> <span class="s2">&quot;sample&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ft</span><span class="o">.</span><span class="n">array</span><span class="p">:</span>
                    <span class="n">fv</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">field_value</span><span class="p">(</span><span class="n">ft</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ft</span><span class="o">.</span><span class="n">role</span><span class="p">)</span>
                    <span class="n">field_type_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_fv_to_hash</span><span class="p">(</span><span class="n">fv</span><span class="p">,</span> <span class="n">ft</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fv_array</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">field_value_array</span><span class="p">(</span><span class="n">ft</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ft</span><span class="o">.</span><span class="n">role</span><span class="p">)</span>
                    <span class="n">field_type_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_fv_array_to_hash</span><span class="p">(</span><span class="n">fv_array</span><span class="p">,</span> <span class="n">ft</span><span class="p">))</span>

        <span class="n">field_type_ids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">field_type_ids</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ot_id</span><span class="p">,</span> <span class="s2">&quot;#&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">field_type_ids</span><span class="p">))</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_group_ops_by_hashes</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">ops</span><span class="p">):</span>
        <span class="n">hashgroup</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_op_to_hash</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
            <span class="n">hashgroup</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">hashgroup</span><span class="p">[</span><span class="n">h</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hashgroup</span>

    <span class="k">def</span> <span class="nf">ipython_link</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">IPython.display</span> <span class="k">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">HTML</span>
            <span class="k">return</span> <span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="s2">&quot;&lt;a href=</span><span class="se">\&quot;</span><span class="si">{url}</span><span class="se">\&quot;</span><span class="s2">&gt;</span><span class="si">{url}</span><span class="s2">&lt;/a&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">)))</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not import IPython. This is likely not installed.&quot;</span><span class="p">)</span>

    <span class="c1"># TODO: find redundant segments</span>
    <span class="c1"># TODO: search functions for plans</span>

    <span class="c1"># TODO: procedure should run on topologically sorted operations, if there is the case that</span>
    <span class="c1"># two operations have different parents, then these operations are NOT mergable</span>
<div class="viewcode-block" id="Planner.optimize_plan"><a class="viewcode-back" href="../../../developer/_autosummary/_autosummary/pydent.planner.planner.html#pydent.planner.planner.Planner.optimize_plan">[docs]</a>    <span class="k">def</span> <span class="nf">optimize_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Optimizes a plan by removing redundent operations.</span>
<span class="sd">        :param planner:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">(</span><span class="s2">&quot;Optimizing plan...&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">operations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">(</span><span class="s2">&quot;   only_operations=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">([</span><span class="n">op</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">operations</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">(</span><span class="s2">&quot;   ignore_types=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ignore</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">operations</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">operations</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">op</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">operations</span> <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;planning&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ignore</span><span class="p">:</span>
            <span class="n">operations</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">op</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">operations</span> <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">operation_type</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ignore</span><span class="p">]</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_ops_by_hashes</span><span class="p">(</span>
            <span class="n">operations</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">}</span>
        <span class="n">num_inputs_rewired</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">num_outputs_rewired</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ops_to_remove</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">op_graph</span> <span class="o">=</span> <span class="n">PlannerLayout</span><span class="o">.</span><span class="n">from_plan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="p">)</span><span class="o">.</span><span class="n">G</span>
        <span class="n">sorted_nodes</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">topological_sort</span><span class="p">(</span><span class="n">op_graph</span><span class="p">)</span>

        <span class="n">visited_groups</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">sorted_nodes</span><span class="p">:</span>
            <span class="n">node_data</span> <span class="o">=</span> <span class="n">op_graph</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">node</span><span class="p">]</span>
            <span class="n">op</span> <span class="o">=</span> <span class="n">node_data</span><span class="p">[</span><span class="s1">&#39;operation&#39;</span><span class="p">]</span>
            <span class="n">op_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op_to_hash</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">op_hash</span> <span class="ow">in</span> <span class="n">visited_groups</span> <span class="ow">or</span> <span class="n">op_hash</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">visited_groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op_hash</span><span class="p">)</span>
            <span class="n">grouped_ops</span> <span class="o">=</span> <span class="n">groups</span><span class="p">[</span><span class="n">op_hash</span><span class="p">]</span>
            <span class="n">op</span> <span class="o">=</span> <span class="n">grouped_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">other_ops</span> <span class="o">=</span> <span class="n">grouped_ops</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

            <span class="c1"># merge wires from other ops into op wires</span>
            <span class="k">for</span> <span class="n">other_op</span> <span class="ow">in</span> <span class="n">other_ops</span><span class="p">:</span>
                <span class="n">connected_ops</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_op_successors</span><span class="p">(</span><span class="n">other_op</span><span class="p">)</span>
                <span class="n">connected_ops</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_op_predecessors</span><span class="p">(</span><span class="n">other_op</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">_op</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;planning&quot;</span> <span class="k">for</span> <span class="n">_op</span> <span class="ow">in</span> <span class="n">connected_ops</span><span class="p">]):</span>
                    <span class="c1"># only optimize if ALL connected operations are in planning status</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">other_op</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
                        <span class="n">in_wires</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_incoming_wires</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">in_wires</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">w</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">operation</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;planning&quot;</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">remove_wire</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">w</span><span class="o">.</span><span class="n">destination</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">add_wire</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                                <span class="n">num_inputs_rewired</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">other_op</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
                        <span class="n">out_wires</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_outgoing_wires</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">out_wires</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">w</span><span class="o">.</span><span class="n">destination</span><span class="o">.</span><span class="n">operation</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;planning&quot;</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">remove_wire</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">w</span><span class="o">.</span><span class="n">destination</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">add_wire</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">w</span><span class="o">.</span><span class="n">destination</span><span class="p">)</span>
                                <span class="n">num_outputs_rewired</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">ops_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">other_op</span><span class="p">)</span>

        <span class="n">operations_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">operations</span>
        <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">ops_to_remove</span><span class="p">:</span>
            <span class="n">operations_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">operations</span> <span class="o">=</span> <span class="n">operations_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{}</span><span class="s2"> operations removed&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ops_to_remove</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{}</span><span class="s2"> input wires re-wired&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_inputs_rewired</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{}</span><span class="s2"> output wires re-wired&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_outputs_rewired</span><span class="p">))</span></div>

<div class="viewcode-block" id="Planner.roots"><a class="viewcode-back" href="../../../developer/_autosummary/_autosummary/pydent.planner.planner.html#pydent.planner.planner.Planner.roots">[docs]</a>    <span class="k">def</span> <span class="nf">roots</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get field values that have no predecessors (i.e. are &#39;roots&#39;)&quot;&quot;&quot;</span>
        <span class="n">roots</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">subgraph</span> <span class="ow">in</span> <span class="n">get_subgraphs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_routing_graph</span><span class="p">()):</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">subgraph</span><span class="p">:</span>
                <span class="n">node</span> <span class="o">=</span> <span class="n">subgraph</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">subgraph</span><span class="o">.</span><span class="n">predecessors</span><span class="p">(</span><span class="n">n</span><span class="p">)))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">root</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;fv&#39;</span><span class="p">]</span>
                    <span class="n">roots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">roots</span></div>

<div class="viewcode-block" id="Planner.validate"><a class="viewcode-back" href="../../../developer/_autosummary/_autosummary/pydent.planner.planner.html#pydent.planner.planner.Planner.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validates sample routes in the plan.</span>

<span class="sd">        :return: dictionary of each sample route and validation errors</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">fv_info</span><span class="p">(</span><span class="n">fv</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{role}</span><span class="s2"> </span><span class="si">{name}</span><span class="s2"> for </span><span class="si">{ot}</span><span class="s2"> </span><span class="si">{opid}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">role</span><span class="o">=</span><span class="n">fv</span><span class="o">.</span><span class="n">role</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="n">fv</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">ot</span><span class="o">=</span><span class="n">fv</span><span class="o">.</span><span class="n">operation</span><span class="o">.</span><span class="n">operation_type</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">opid</span><span class="o">=</span><span class="n">fv</span><span class="o">.</span><span class="n">operation</span><span class="o">.</span><span class="n">id</span>
            <span class="p">)</span>

        <span class="n">routes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">subgraph</span> <span class="ow">in</span> <span class="n">get_subgraphs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_routing_graph</span><span class="p">()):</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">reasons</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">root</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">subgraph</span><span class="p">:</span>
                <span class="n">node</span> <span class="o">=</span> <span class="n">subgraph</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
                <span class="n">fv</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;fv&#39;</span><span class="p">]</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">fv</span><span class="o">.</span><span class="n">sample</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">fv</span><span class="o">.</span><span class="n">field_type</span><span class="o">.</span><span class="n">ftype</span> <span class="o">==</span> <span class="s1">&#39;sample&#39;</span><span class="p">:</span>
                    <span class="n">reasons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> has no sample defined&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fv_info</span><span class="p">(</span><span class="n">fv</span><span class="p">)))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">fv</span><span class="o">.</span><span class="n">item</span><span class="p">:</span>
                        <span class="n">item</span> <span class="o">=</span> <span class="n">fv</span><span class="o">.</span><span class="n">item</span>
                        <span class="n">collection</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">as_collection</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">collection</span><span class="p">:</span>
                            <span class="n">item</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">part</span><span class="p">(</span><span class="n">fv</span><span class="o">.</span><span class="n">row</span><span class="p">,</span> <span class="n">fv</span><span class="o">.</span><span class="n">column</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">sample_id</span> <span class="o">!=</span> <span class="n">fv</span><span class="o">.</span><span class="n">sample</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
                            <span class="n">reasons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> has sample_id=</span><span class="si">{}</span><span class="s2"> but generated item has sample_id=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                    <span class="n">fv_info</span><span class="p">(</span><span class="n">fv</span><span class="p">),</span>
                                    <span class="n">fv</span><span class="o">.</span><span class="n">sample</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">sample_id</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                    <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">subgraph</span><span class="o">.</span><span class="n">predecessors</span><span class="p">(</span><span class="n">n</span><span class="p">)))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">root</span> <span class="o">=</span> <span class="n">fv</span>
            <span class="k">if</span> <span class="n">root</span><span class="o">.</span><span class="n">item</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">root</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;input&quot;</span> <span class="ow">and</span> <span class="n">root</span><span class="o">.</span><span class="n">field_type</span><span class="o">.</span><span class="n">ftype</span> <span class="o">==</span> <span class="s1">&#39;sample&#39;</span><span class="p">:</span>
                <span class="n">reasons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> has no item defined&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fv_info</span><span class="p">(</span><span class="n">fv</span><span class="p">)))</span>
            <span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">reasons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;different samples defined in route (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
            <span class="n">root_id</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> for </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">root</span><span class="o">.</span><span class="n">operation</span><span class="o">.</span><span class="n">operation_type</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_routing_id</span><span class="p">(</span><span class="n">root</span><span class="p">))</span>
            <span class="n">routes</span><span class="p">[</span><span class="n">root_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;root_field_value&quot;</span><span class="p">:</span> <span class="n">root</span><span class="p">,</span>
                <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="n">reasons</span><span class="p">,</span>
                <span class="s2">&quot;valid&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">reasons</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="p">}</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">routes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">True</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">errors</span></div>
        <span class="c1"># return routes</span>

    <span class="c1"># TODO: implement planner.copy and anonymize the operations and field_values by removing their ids</span>
<div class="viewcode-block" id="Planner.copy"><a class="viewcode-back" href="../../../developer/_autosummary/_autosummary/pydent.planner.planner.html#pydent.planner.planner.Planner.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a copy of this planner, with a new anonymous copy of the plan. Browser cache is copied as well,</span>
<span class="sd">        but model_cache in browser are not anonymous&quot;&quot;&quot;</span>
        <span class="c1"># copy everything execpt plan, which may be large</span>
        <span class="n">copied</span> <span class="o">=</span> <span class="n">empty_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;_plan&#39;</span><span class="p">)</span>
        <span class="n">copied</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># copy over anonymous copy</span>
        <span class="n">copied</span><span class="o">.</span><span class="n">_plan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">copied</span></div>

    <span class="k">def</span> <span class="nf">__copy__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">combine</span><span class="p">(</span><span class="n">plans</span><span class="p">):</span>
        <span class="n">copied_plans</span> <span class="o">=</span> <span class="p">[</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">plans</span><span class="p">]</span>

        <span class="n">sessions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">session</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">plans</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sessions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PlannerException</span><span class="p">(</span><span class="s2">&quot;Cannot combine plans, plans must all derive from same session instance&quot;</span><span class="p">)</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">sessions</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="n">new_plan</span> <span class="o">=</span> <span class="n">Planner</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
        <span class="n">new_plan</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">operations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">copied_plans</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">operations</span><span class="p">))</span>
            <span class="n">new_plan</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">operations</span> <span class="o">+=</span> <span class="n">p</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">operations</span>
            <span class="n">new_plan</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">wires</span> <span class="o">+=</span> <span class="n">p</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">wires</span>
        <span class="k">return</span> <span class="n">new_plan</span>

<div class="viewcode-block" id="Planner.split"><a class="viewcode-back" href="../../../developer/_autosummary/_autosummary/pydent.planner.planner.html#pydent.planner.planner.Planner.split">[docs]</a>    <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Split the plan into several distinct plans, if possible. This first convert the plan</span>
<span class="sd">         to an operation graph, find subgraphs that are not connected to each other,</span>
<span class="sd">         and create new plans based on these subgraphs. This will return anonymous copies of all</span>
<span class="sd">        the plans, meaning operations and field_values will be anonymized. Sample and items attached to</span>
<span class="sd">        field values will remain to avoid re-creating samples and items.&quot;&quot;&quot;</span>

        <span class="c1"># copy this plan</span>
        <span class="n">copied_plan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># get independent operation graphs</span>
        <span class="n">layouts</span> <span class="o">=</span> <span class="n">copied_plan</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">get_independent_layouts</span><span class="p">()</span>

        <span class="c1"># for each independent graph, make a new plan</span>
        <span class="n">new_plans</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">layout</span> <span class="ow">in</span> <span class="n">layouts</span><span class="p">:</span>
            <span class="n">new_plan</span> <span class="o">=</span> <span class="n">Planner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>
            <span class="n">new_plans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_plan</span><span class="p">)</span>

            <span class="c1"># copy over the operations</span>
            <span class="n">opids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">layout</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
            <span class="n">ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">layout</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">opid</span><span class="p">][</span><span class="s1">&#39;operation&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">opid</span> <span class="ow">in</span> <span class="n">opids</span><span class="p">]</span>
            <span class="n">wires</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># copy over relevant wires</span>
            <span class="k">for</span> <span class="n">wire</span> <span class="ow">in</span> <span class="n">copied_plan</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">wires</span><span class="p">:</span>
                <span class="n">to_id</span> <span class="o">=</span> <span class="n">wire</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">operation</span><span class="o">.</span><span class="n">_primary_key</span>
                <span class="n">from_id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">wire</span><span class="p">,</span> <span class="s1">&#39;from&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">operation</span><span class="o">.</span><span class="n">_primary_key</span>
                <span class="k">if</span> <span class="n">to_id</span> <span class="ow">in</span> <span class="n">opids</span> <span class="ow">or</span> <span class="n">from_id</span> <span class="ow">in</span> <span class="n">opids</span><span class="p">:</span>
                    <span class="n">wires</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wire</span><span class="p">)</span>

            <span class="n">new_plan</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">operations</span> <span class="o">=</span> <span class="n">ops</span>
            <span class="n">new_plan</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">wires</span> <span class="o">=</span> <span class="n">wires</span>
        <span class="k">return</span> <span class="n">new_plans</span></div>

    <span class="c1"># TODO: implement individual wires and things</span>
    <span class="k">def</span> <span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layout</span>
        <span class="n">edge_colors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">layout</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">edges</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span>
            <span class="n">wire</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;wire&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">wire</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">sample</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;orange&quot;</span>
            <span class="k">elif</span> <span class="n">wire</span><span class="o">.</span><span class="n">destination</span><span class="o">.</span><span class="n">sample</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;orange&quot;</span>
            <span class="k">elif</span> <span class="n">wire</span><span class="o">.</span><span class="n">destination</span><span class="o">.</span><span class="n">sample</span> <span class="o">!=</span> <span class="n">wire</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">sample</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span>
            <span class="n">edge_colors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
        <span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">G</span><span class="p">,</span> <span class="n">edge_colors</span><span class="o">=</span><span class="n">edge_colors</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">pos</span><span class="p">())</span></div>

</pre></div>

          </div>
            
        </div>
        <div class="clearfix"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Trident 1.0.0a2 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
<script type="text/javascript">
  $("#mobile-toggle a").click(function () {
    $("#left-column").toggle();
  });
</script>
<script type="text/javascript" src="../../../_static/js/bootstrap.js"></script>
  <div class="footer">
    &copy; Copyright 2017, University of Washington. Created using <a href="http://sphinx.pocoo.org/">Sphinx</a>.
  </div>
  </body>
</html>