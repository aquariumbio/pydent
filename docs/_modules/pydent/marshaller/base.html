<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>pydent.marshaller.base &#8212; pydent 0.1.4a documentation</title>
    <link rel="stylesheet" href="../../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../../_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="../../../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../../../_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../../../_static/bootstrap-sphinx.js "></script>

  </head><body>
    


  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../index.html">
          Trident</a>
        <span class="navbar-text navbar-version pull-left"><b>0.1.4a</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../index.html">Trident <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../../basics/installation.html">Installing Trident</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../basics/installation.html#installation-for-developers">Installation for developers</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../basics/getting_started.html">Getting Started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../basics/getting_started.html#logging-into-a-session">Logging into a session</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../basics/getting_started.html#models">Models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../basics/getting_started.html#making-queries">Making queries</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../basics/getting_started.html#relationship-queries">Relationship Queries</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../basics/getting_started.html#creating-inventory">Creating inventory</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../basics/querying.html">Making Queries</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../basics/querying.html#basic-browsing">Basic Browsing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../basics/querying.html#browser-scope">Browser Scope</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../basics/querying.html#relationship-browsing">Relationship Browsing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../basics/querying.html#logging-requests">Logging Requests</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../basics/querying.html#asynchrounous-requests">Asynchrounous Requests</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../basics/planning.html">Experiment Planning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer/api_reference.html">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../developer/api_reference.html#submodules">Submodules</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer/contributing.html">Contributing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../developer/contributing.html#running-tests">Running Tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../developer/contributing.html#installing-dependencies">Installing dependencies</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../advanced/topics.html">Advanced topics</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../advanced/caching.html">Speeding up queries</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../advanced/planner_tutorial.html">Planner tutorial</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer/versions.html">Version History</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../developer/versions.html#alpha">0.1.3-alpha</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../developer/versions.html#id1">0.1.2-alpha</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
              
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <h1>Source code for pydent.marshaller.base</h1><div class="highlight"><pre>
<span></span>&quot;&quot;&quot;
Model base class
&quot;&quot;&quot;

from pydent.marshaller.exceptions import SchemaException, SchemaModelException
from pydent.marshaller.schema import DynamicSchema, SchemaRegistry
from pydent.marshaller.fields import Callback
from pydent.marshaller.registry import ModelRegistry
from pydent.marshaller.descriptors import DataAccessor
from copy import deepcopy
import functools
import inspect


<div class="viewcode-block" id="add_schema"><a class="viewcode-back" href="../../../developer/_autosummary/_autosummary/pydent.marshaller.base.html#pydent.marshaller.base.add_schema">[docs]</a>def add_schema(cls):
    &quot;&quot;&quot;Decorator that dynamically attaches a schema to a model.&quot;&quot;&quot;

    if not issubclass(cls, SchemaModel):
        raise SchemaException(&quot;Model must be a subclaass of &#39;{}&#39;&quot;.format(SchemaModel))
    new_schema = SchemaRegistry(
        SchemaRegistry.make_schema_name(cls.__name__),
        (DynamicSchema,),
        {&quot;_model_class&quot;: cls},
    )
    new_schema.register(cls)
    return cls</div>


<div class="viewcode-block" id="SchemaModel"><a class="viewcode-back" href="../../../developer/_autosummary/_autosummary/pydent.marshaller.base.html#pydent.marshaller.base.SchemaModel">[docs]</a>class SchemaModel(metaclass=ModelRegistry):
    &quot;&quot;&quot;
    A Schema class that holds information on serialization/deserialization
    &quot;&quot;&quot;

    __slots__ = [ModelRegistry._data_key, ModelRegistry._deserialized_key, &quot;__dict__&quot;]

    def __init__(self, data=None):
        &quot;&quot;&quot;
        The model initializer.

        :param data: data to add to the model
        :type data: dict
        &quot;&quot;&quot;
        if data is None:
            data = {}
        if not getattr(self, ModelRegistry._data_key, None):
            setattr(self, ModelRegistry._data_key, data)
        if not getattr(self, ModelRegistry._deserialized_key, None):
            setattr(self, ModelRegistry._deserialized_key, {})
        self.add_data(data)

    @property
    def model_schema(self):
        &quot;&quot;&quot;
        Returns the attached model schema.

        :return: the model&#39;s schema class
        :rtype: DynamicSchema
        &quot;&quot;&quot;
        return getattr(self.__class__, &quot;model_schema&quot;, None)

<div class="viewcode-block" id="SchemaModel.add_data"><a class="viewcode-back" href="../../../developer/_autosummary/_autosummary/pydent.marshaller.base.html#pydent.marshaller.base.SchemaModel.add_data">[docs]</a>    def add_data(self, data):
        &quot;&quot;&quot;Initializes fake attributes that correspond to data.&quot;&quot;&quot;
        if not self.model_schema:
            filepath = &quot;&quot;
            try:
                filepath = inspect.getfile(self.__class__)
            except:
                pass
            raise SchemaModelException(
                &quot;Cannot initialize a {} without a {}. &quot;
                &quot;Use &#39;@{}&#39; to decorate the class definition for &#39;{}&#39; located in {}&quot;.format(
                    SchemaModel.__name__,
                    DynamicSchema.__name__,
                    add_schema.__name__,
                    self.__class__.__name__,
                    filepath,
                )
            )
        if data is not None:
            self.__class__.model_schema.init_data_accessors(self, data)</div>

<div class="viewcode-block" id="SchemaModel._get_data"><a class="viewcode-back" href="../../../developer/_autosummary/_autosummary/pydent.marshaller.base.html#pydent.marshaller.base.SchemaModel._get_data">[docs]</a>    def _get_data(self):
        &quot;&quot;&quot;Return the model&#39;s data&quot;&quot;&quot;
        return getattr(self, self.__class__._data_key)</div>

    def _get_deserialized_data(self):
        return getattr(self, self.__class__._deserialized_key)

    def get_deserialized(self, name):
        return self._get_deserialized_data()[name]

    def has_deserialize(self, name):
        assert name in self._get_deserialized_data()

    @classmethod
    def _set_data(cls, data, calling_obj=None):
        instance = SchemaModel.__new__(cls)
        SchemaModel.__init__(instance, data)
        return instance

    @staticmethod
    def _keys_to_dict(keys):
        if keys is None:
            return {}
        elif isinstance(keys, str):
            return {keys: None}
        elif isinstance(keys, dict):
            return dict(keys)
        else:
            return {k: None for k in keys}

    @classmethod
    def _dump(cls, obj, only=None, include=None, ignore=None):
        if not issubclass(type(obj), SchemaModel):
            return obj

        only = cls._keys_to_dict(only)
        include = cls._keys_to_dict(include)
        ignore = cls._keys_to_dict(ignore)

        data = {}

        serialized_data = obj._get_data()

        include_and_only = set(include).union(set(only))

        for fname in include_and_only:
            getattr(obj, fname)

        keys = set(serialized_data.keys())
        keys = keys.difference(set(ignore))
        if only:
            keys = keys.intersection(set(only))

        model_fields = obj.__class__.model_schema.fields

        callback_fields = []
        always_dump = []
        for fname, field in model_fields.items():
            if hasattr(field, &quot;nested&quot;) or issubclass(type(field), Callback):
                callback_fields.append(fname)
            if getattr(field, &quot;always_dump&quot;, None):
                always_dump.append(fname)

        include_and_only = include_and_only.union(set(always_dump))
        callback_keys = include_and_only.intersection(set(callback_fields))
        callback_keys = callback_keys.difference(set(ignore))

        data_keys = keys.difference(set(callback_fields))

        for key in data_keys:
            data[key] = serialized_data[key]
        for key in callback_keys:
            field = model_fields[key]
            val = getattr(obj, key)
            dump = functools.partial(
                cls._dump,
                include=include.pop(key, None),
                only=only.pop(key, None),
                ignore=ignore.pop(key, None),
            )
            if getattr(model_fields[key], &quot;nested&quot;, None) and model_fields[key].many:
                if isinstance(val, list):
                    data[field.data_key] = [dump(v) for v in val]
            else:
                data[field.data_key] = dump(val)
        return data

<div class="viewcode-block" id="SchemaModel.dump"><a class="viewcode-back" href="../../../developer/_autosummary/_autosummary/pydent.marshaller.base.html#pydent.marshaller.base.SchemaModel.dump">[docs]</a>    def dump(self, only=None, include=None, ignore=None):
        &quot;&quot;&quot;
        Dump/serializes the model to a json-like dictionary.

        :param only: restricts dump/serialization to the provided keys
        :type only: basestring|list|tuple|dict
        :param include: include any callback fields in the dump/serialization
        :type include: basestring|list|tuple|dict
        :param ignore: ignores fields in the dump/serialization
        :type ignore: basestring|list|tuple|dict
        :return: the serialized data
        :rtype: dict
        &quot;&quot;&quot;
        return deepcopy(self._dump(self, only=only, include=include, ignore=ignore))</div>

    # def __dir__(self):
    #     return [&#39;a&#39;]

<div class="viewcode-block" id="SchemaModel.load"><a class="viewcode-back" href="../../../developer/_autosummary/_autosummary/pydent.marshaller.base.html#pydent.marshaller.base.SchemaModel.load">[docs]</a>    @classmethod
    def load(cls, data):
        &quot;&quot;&quot;
        Deserialize the data to a model.

        :param data: data to deserialize
        :type data: dict
        :return: the deserialized model
        :rtype: SchemaModel
        &quot;&quot;&quot;
        return cls._set_data(data)</div>

    def __setstate__(self, state):
        &quot;&quot;&quot;Overrides how models are unpickled. The default way pickling works by dumping
        the __dict__ along with the class definition. Since the way data is handle in
        the marshaller object involves dynamic creation of descriptors, these are not properly
        handled upon load. Here we will create these descriptors upon
        unpickling. Unlike serialized data, deserialized data is handled explicitly using &#39;fields&#39; in the
        schema/model definition, it is not necessary to do anything with these descriptors.&quot;&quot;&quot;
        self.__dict__ = state

        # add data accessors
        data = state[ModelRegistry._data_key]
        for k in data:
            if k not in self.__class__.__dict__:
                setattr(self.__class__, k, DataAccessor(k, ModelRegistry._data_key))</div>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2017-2019, University of Washington.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.1.2.<br/>
    </p>
  </div>
</footer>
  </body>
</html>