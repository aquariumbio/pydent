<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>pydent.aqhttp &#8212; pydent 0.1.0 documentation</title>
    <link rel="stylesheet" href="../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="../../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../../_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../../_static/bootstrap-sphinx.js "></script>

  </head><body>
    


  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../index.html">
          Trident</a>
        <span class="navbar-text navbar-version pull-left"><b>0.1.0</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../index.html">Trident <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../basics/installation.html">Installing Trident</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../basics/installation.html#installation-for-developers">Installation for developers</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../basics/getting_started.html">Getting Started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../basics/getting_started.html#logging-into-a-session">Logging into a session</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../basics/getting_started.html#models">Models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../basics/getting_started.html#making-queries">Making queries</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../basics/getting_started.html#relationship-queries">Relationship Queries</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../basics/getting_started.html#creating-inventory">Creating inventory</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../basics/querying.html">Making Queries</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../basics/querying.html#basic-browsing">Basic Browsing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../basics/querying.html#browser-scope">Browser Scope</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../basics/querying.html#relationship-browsing">Relationship Browsing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../basics/querying.html#logging-requests">Logging Requests</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../basics/querying.html#asynchrounous-requests">Asynchrounous Requests</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../basics/planning.html">Experiment Planning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer/api_reference.html">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../developer/api_reference.html#submodules">Submodules</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../developer/contributing.html">Contributing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../developer/contributing.html#running-tests">Running Tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../developer/contributing.html#installing-dependencies">Installing dependencies</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../advanced/topics.html">Advanced topics</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../advanced/caching.html">Speeding up queries</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../advanced/planner_tutorial.html">Planner tutorial</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../developer/versions.html">Version History</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../developer/versions.html#id1">0.1.0</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
              
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <h1>Source code for pydent.aqhttp</h1><div class="highlight"><pre>
<span></span>&quot;&quot;&quot;
Request class for making raw http requests to Aquarium

This module contains the AqHTTP class, which can make arbitrary post/put/get
requests to Aquarium and returns JSON data.

Generally, Trident users should be unable to make arbitrary requests using this
class.
Users should only access these methods indirectly through a ``Session`` or
``SessionInterface`` instance.
&quot;&quot;&quot;

import json

import requests

from pydent.exceptions import (
    TridentRequestError,
    TridentLoginError,
    TridentTimeoutError,
    TridentJSONDataIncomplete,
    ForbiddenRequestError,
)
from pydent.utils import url_build, logger


<div class="viewcode-block" id="AqHTTP"><a class="viewcode-back" href="../../developer/_autosummary/pydent.aqhttp.html#pydent.aqhttp.AqHTTP">[docs]</a>class AqHTTP(logger.Loggable, object):
    &quot;&quot;&quot;
    Defines a session/connection to Aquarium.
    Makes HTTP requests to Aquarium and returns JSON.

    This class should be obscured from Trident user so that users cannot make
    arbitrary requests to an Aquarium server and get sensitive information
    (e.g. User json that is returned contains api_key, password_digest, etc.)
    or make damaging posts.
    Instead, a SessionInterface should be the object that makes these requests.
    &quot;&quot;&quot;

    TIMEOUT = 10

    def __init__(self, login, password, aquarium_url):
        &quot;&quot;&quot;
        Initializes an aquarium session with login, password, and server.

        :param login: Aquarium login
        :type login: str
        :param aquarium_url: aquarium url to the server
        :type aquarium_url: str
        &quot;&quot;&quot;
        self.login = login
        self.aquarium_url = aquarium_url
        self._requests_session = None
        self.timeout = self.__class__.TIMEOUT
        self._login(login, password)
        self.init_logger(&quot;AqHTTP@{}&quot;.format(aquarium_url))
        self._using_requests = True
        self.num_requests = 0

    def on(self):
        self._using_requests = True

    def off(self):
        self._using_requests = False

    def _format_response_info(self, response, include_text=False, include_body=True):
        if response is not None:
            if response.status_code &gt;= 400:
                include_text = True
            info = dict(response.request.__dict__)
            info.update({&quot;seconds&quot;: response.elapsed.total_seconds()})
            msg = &quot;REQUEST: (t={seconds}s)  {method} {url}&quot;.format(**info)
            if include_body:
                body = info[&quot;body&quot;]
                try:
                    my_json = body.decode(&quot;utf8&quot;).replace(&quot;&#39;&quot;, &#39;&quot;&#39;)
                    body = json.loads(my_json)
                    body = self._pprint_data(body, max_list_len=10)
                except:
                    pass
                msg = msg + &quot;\n&quot; + &quot;BODY: {body}&quot;.format(body=body)
            if include_text:
                text = getattr(response, &quot;text&quot;, &quot;&quot;)
                try:
                    text = json.dumps(json.loads(text), indent=2)
                except:
                    pass
                msg = msg + &quot;\n&quot; + &quot;TEXT: {text}&quot;.format(text=text)
            return msg
        return &quot;RESPONSE: NO RESPONSE&quot;

    def _format_request_status(self, response):
        if response is not None:
            return &quot;STATUS:  {} {}&quot;.format(response.status_code, response.reason)
        return &quot;STATUS: NO RESPONSE&quot;

    @property
    def url(self):
        &quot;&quot;&quot;An alias of aquarium_url&quot;&quot;&quot;
        return self.aquarium_url

    @staticmethod
    def create_session_json(login, password):
        return {&quot;session&quot;: {&quot;login&quot;: login, &quot;password&quot;: password}}

<div class="viewcode-block" id="AqHTTP._login"><a class="viewcode-back" href="../../developer/_autosummary/pydent.aqhttp.html#pydent.aqhttp.AqHTTP._login">[docs]</a>    def _login(self, login, password):
        &quot;&quot;&quot;
        Login to aquarium and saves header as a requests.Session()
        &quot;&quot;&quot;
        session_data = self.create_session_json(login, password)
        try:
            res = requests.post(
                url_build(self.aquarium_url, &quot;sessions.json&quot;),
                json=session_data,
                timeout=self.timeout,
            )
            if res is None:
                raise requests.exceptions.ConnectionError
            cookies = dict(res.cookies)

            # Check for remember token
            if not any([&quot;remember_token&quot; in k for k in dict(res.cookies)]):
                raise TridentLoginError(
                    &quot;Authentication error. Remember token not found in login request.&quot;
                    &quot; Contact developers.&quot;
                )

            # fix remember token (for some outdated versions of Aquarium)
            for c in dict(cookies):
                if &quot;remember_token&quot; in c:
                    cookies[&quot;remember_token&quot;] = cookies[c]
            # TODO: do we remove the session cookie to handle asynchronous requests?
            self.cookies = dict(cookies)
        except requests.exceptions.MissingSchema as error:
            raise TridentLoginError(
                &quot;Aquarium URL {0} incorrectly formatted. {1}&quot;.format(
                    self.aquarium_url, error.args[0]
                )
            )
        except requests.exceptions.ConnectTimeout:
            raise TridentTimeoutError(
                &quot;Either Aquarium took too long to respond during login or your internet&quot;
                &quot; connection is slow. Make sure the url {} is correct.&quot;
                &quot; Alternatively, use Session.set_timeout&quot;
                &quot; to increase the request timeout.&quot;.format(self.aquarium_url)
            )
        except requests.exceptions.ConnectionError:
            raise TridentLoginError(
                &quot;Could not contact &#39;{}&#39;. Login request returned no response&quot;.format(
                    self.aquarium_url
                )
            )</div>

    @staticmethod
    def _serialize_request(url, method, body):
        return json.dumps({&quot;url&quot;: url, &quot;method&quot;: method, &quot;body&quot;: body}, sort_keys=True)

<div class="viewcode-block" id="AqHTTP.request"><a class="viewcode-back" href="../../developer/_autosummary/pydent.aqhttp.html#pydent.aqhttp.AqHTTP.request">[docs]</a>    def request(self, method, path, timeout=None, allow_none=True, **kwargs):
        &quot;&quot;&quot;
        Performs a http request.

        :param method: request method (e.g. &#39;put&#39;, &#39;post&#39;, &#39;get&#39;, etc.)
        :type method: str
        :param path: url to perform the request
        :type path: str
        :param timeout: time in seconds to process request before raising
                exception
        :type timeout: int
        :param allow_none: if False will raise error when json_data
                contains a None or null value (default: True)
        :type allow_none: boolean
        :param kwargs: additional arguments to post to request
        :type kwargs: dict
        :return: json
        :rtype: dict
        &quot;&quot;&quot;

        url = url_build(self.aquarium_url, path)
        if not self._using_requests:
            raise ForbiddenRequestError(
                &quot;Attempted a request ({} {}) when requests have been turned OFF.\nDATA: {}&quot;.format(
                    method.upper(), url, kwargs[&quot;json&quot;]
                )
            )

        if timeout is None:
            timeout = self.timeout
        if not allow_none and &quot;json&quot; in kwargs:
            self._disallow_null_in_json(kwargs[&quot;json&quot;])

        self.num_requests += 1
        response = requests.request(
            method, url, timeout=timeout, cookies=self.cookies, **kwargs
        )

        self._info(self._format_response_info(response))
        if response.status_code &gt;= 400:
            response_info = self._format_response_info(response)
            request_status = self._format_request_status(response)
            msg = &quot;\n&quot;.join(
                [
                    &quot;The Aquarium server returned an error.&quot;,
                    request_status,
                    response_info,
                ]
            )
            raise TridentRequestError(msg, response)

        return self._response_to_json(response)</div>

<div class="viewcode-block" id="AqHTTP._response_to_json"><a class="viewcode-back" href="../../developer/_autosummary/pydent.aqhttp.html#pydent.aqhttp.AqHTTP._response_to_json">[docs]</a>    def _response_to_json(self, response):
        &quot;&quot;&quot;
        Turns :class:`requests.Request` instance into a json.
        Raises TridentRequestError if an error occurs.
        &quot;&quot;&quot;

        if response.url == url_build(self.aquarium_url, &quot;signin&quot;):
            msg = (
                &quot;There was an error with authenticating the request. Aquarium &quot;
                + &quot;re-routed to the sign-in page.&quot;
            )
            raise TridentRequestError(msg, response)

        try:
            response_json = response.json()
        except json.JSONDecodeError:
            msg = &quot;Response is not JSON formatted&quot;
            msg += &quot;\nMessage:\n&quot; + response.text
            self._error(self._format_response_info(response))
            raise TridentRequestError(msg, response)
        if response_json:
            if &quot;errors&quot; in response_json:
                errors = response_json[&quot;errors&quot;]
                if isinstance(errors, list):
                    errors = &quot;\n&quot;.join(errors)
                msg = &quot;Error response:\n{}&quot;.format(errors)
                raise TridentRequestError(msg, response)
        return response_json</div>

<div class="viewcode-block" id="AqHTTP._disallow_null_in_json"><a class="viewcode-back" href="../../developer/_autosummary/pydent.aqhttp.html#pydent.aqhttp.AqHTTP._disallow_null_in_json">[docs]</a>    @staticmethod
    def _disallow_null_in_json(json_data):
        &quot;&quot;&quot;
        Raises :class:pydent.exceptions.TridentJSONDataIncomplete exception if
        json data being sent contains a null value
        &quot;&quot;&quot;
        if None in json_data.values():
            raise TridentJSONDataIncomplete(
                &quot;JSON data {} contains a null value.&quot;.format(json_data)
            )</div>

<div class="viewcode-block" id="AqHTTP.post"><a class="viewcode-back" href="../../developer/_autosummary/pydent.aqhttp.html#pydent.aqhttp.AqHTTP.post">[docs]</a>    def post(self, path, json_data=None, timeout=None, allow_none=True, **kwargs):
        &quot;&quot;&quot;
        Make a post request to the session

        :param path: url
        :type path: str
        :param json_data: json_data to post
        :type json_data: dict
        :param timeout: time in seconds to process request before raising
                exception
        :type timeout: int
        :param allow_none: if False throw error if json_data contains a null
                or None value (default True)
        :type allow_none: boolean
        :param kwargs: additional arguments to post to request
        :type kwargs: dict
        :return: json
        :rtype: dict
        &quot;&quot;&quot;
        return self.request(
            &quot;post&quot;,
            path,
            json=json_data,
            timeout=timeout,
            allow_none=allow_none,
            **kwargs
        )</div>

<div class="viewcode-block" id="AqHTTP.put"><a class="viewcode-back" href="../../developer/_autosummary/pydent.aqhttp.html#pydent.aqhttp.AqHTTP.put">[docs]</a>    def put(self, path, json_data=None, timeout=None, allow_none=True, **kwargs):
        &quot;&quot;&quot;
        Make a put request to the session

        :param path: url
        :type path: str
        :param json_data: json_data to post
        :type json_data: dict
        :param timeout: time in seconds to process request before raising
                exception
        :type timeout: int
        :param allow_none: if False throw error when json_data contains a null
                or None value (default True)
        :type allow_none: boolean
        :param kwargs: additional arguments to post to request
        :type kwargs: dict
        :return: json
        :rtype: dict
        &quot;&quot;&quot;
        return self.request(
            &quot;put&quot;,
            path,
            json=json_data,
            timeout=timeout,
            allow_none=allow_none,
            **kwargs
        )</div>

<div class="viewcode-block" id="AqHTTP.get"><a class="viewcode-back" href="../../developer/_autosummary/pydent.aqhttp.html#pydent.aqhttp.AqHTTP.get">[docs]</a>    def get(self, path, timeout=None, allow_none=True, **kwargs):
        &quot;&quot;&quot;
        Make a get request to the session

        :param path: url
        :type path: str
        :param timeout: time in seconds to process request before raising
                exception
        :type timeout: int
        :param allow_none: if False throw error when json_data contains a null
                or None value (default: True)
        :type allow_none: boolean
        :param kwargs: additional arguments to post to request
        :type kwargs: dict
        :return: json
        :rtype: dict
        &quot;&quot;&quot;
        return self.request(
            &quot;get&quot;, path, timeout=timeout, allow_none=allow_none, **kwargs
        )</div>

    def delete(self, path, timeout=None, **kwargs):
        return self.request(&quot;delete&quot;, path, timeout=timeout, **kwargs)

    def __repr__(self):
        return &quot;&lt;{}(user=&#39;{}&#39;, url=&#39;{}&#39;)&gt;&quot;.format(
            self.__class__.__name__, self.login, self.aquarium_url
        )

    def __str__(self):
        return self.__repr__()</div>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2019, University of Washington.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.1.2.<br/>
    </p>
  </div>
</footer>
  </body>
</html>