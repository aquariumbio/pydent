<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Making Queries &#8212; Trident 0.1.0a3 documentation</title>
    <link rel="stylesheet" href="_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Experiment Planning" href="planning.html" />
    <link rel="prev" title="Getting Started" href="getting_started.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="_static/bootstrap-sphinx.js "></script>

  </head><body>
    


  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="index.html">
          Trident</a>
        <span class="navbar-text navbar-version pull-left"><b>0.1.0a3</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="index.html">Trident <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Making Queries</a></li>
<li class="toctree-l1"><a class="reference internal" href="planning.html">Experiment Planning</a></li>
<li class="toctree-l1"><a class="reference internal" href="developer/api_reference.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="advanced.html">Advanced tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="versions.html">Version History</a></li>
</ul>
</ul>
</li>
              
            
            
            
            
            
              <li class="hidden-sm">
<div id="sourcelink">
  <a href="_sources/querying.rst.txt"
     rel="nofollow">Source</a>
</div></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <div class="section" id="making-queries">
<h1>Making Queries<a class="headerlink" href="#making-queries" title="Permalink to this headline">¶</a></h1>
<p>Trident provides a browser class to help browse through Inventory.
Samples can be searched via regular expressions, close-matches, or by sample properties.
As of 10/2018, these types of searching capabilities are not implemented in the
Aquarium Sample Browser GUI and can only be accessed through Trident.</p>
<p>A new Browser can be initialized by passing in a AqSession object:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pydent</span> <span class="k">import</span> <span class="n">AqSession</span>
<span class="kn">from</span> <span class="nn">pydent.browser</span> <span class="k">import</span> <span class="n">Browser</span>

<span class="n">session</span> <span class="o">=</span> <span class="n">AqSession</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">,</span> <span class="s1">&#39;http://123.23.4.3&#39;</span><span class="p">)</span>
<span class="n">browser</span> <span class="o">=</span> <span class="n">Browser</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="basic-browsing">
<h2>Basic Browsing<a class="headerlink" href="#basic-browsing" title="Permalink to this headline">¶</a></h2>
<p>Basic regular expression searches of samples by using the ‘search’ method:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># perform a regex search of samples containing &#39;gfp&#39;</span>
<span class="n">gfp_samples</span> <span class="o">=</span> <span class="n">browser</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;.*GFP.*&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Additional flags can be passed into the regex search to narrow the search:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># perform a regex search of samples containing &#39;pGFP&#39;, without ignoring case</span>
<span class="n">GFP_sample</span> <span class="o">=</span> <span class="n">browser</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;.*GFP.*&quot;</span><span class="p">,</span> <span class="n">ignore_case</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># perform a regex search of all Plasmids containing &#39;pGFP&#39;, without ignoring case</span>
<span class="n">gfp_fragments</span> <span class="o">=</span> <span class="n">browser</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;.*GFP.*&quot;</span><span class="p">,</span> <span class="n">ignore_case</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sample_type</span><span class="o">=</span><span class="s1">&#39;Plasmid&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Similarly, the browser can also find approximately close matches for a given string:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">close_matches</span> <span class="o">=</span> <span class="n">browser</span><span class="o">.</span><span class="n">close_matches</span><span class="p">(</span><span class="s2">&quot;pMOD8-pGRR-W8&quot;</span><span class="p">)</span>
<span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">close_matches</span><span class="p">]</span>
<span class="c1"># [&#39;pMOD8A-RGR-W8&#39;, &#39;pMOD8-pGALz4-RGR-W8&#39;, &#39;pMOD8-pGALZ4-URGR-W8&#39;]</span>
</pre></div>
</div>
<p>Once found, list of samples can also be filtered by their sample properties.
For example, we can find all of the primers containing “mcherry” that have a
<em>T Anneal</em> greater than 64:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">primers</span> <span class="o">=</span> <span class="n">browser</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;.*mcherry.*&quot;</span><span class="p">,</span> <span class="n">sample_type</span><span class="o">=</span><span class="s2">&quot;Primer&quot;</span><span class="p">)</span>
<span class="n">browser</span><span class="o">.</span><span class="n">filter_by_field_value_properties</span><span class="p">(</span><span class="n">primers</span><span class="p">,</span> <span class="s2">&quot;name = &#39;T Anneal&#39; AND value &gt; 64&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>As you can see, there is a SQL-like style to the query. This same style can be applied directly
to where statements as well:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">session</span><span class="o">.</span><span class="n">FieldValue</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;name = &#39;T Anneal&#39; AND value &gt; 64&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="browser-scope">
<h2>Browser Scope<a class="headerlink" href="#browser-scope" title="Permalink to this headline">¶</a></h2>
<p>The model scope of the browser can also be changed so that many of the methods
used in Sample, can be applied to other models (such as Operations or OperationTypes).
The following example finds protocols that look similar to “Fragment Analyzing”</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">browser</span><span class="o">.</span><span class="n">set_model</span><span class="p">(</span><span class="s2">&quot;OperationType&quot;</span><span class="p">)</span>
<span class="n">ots</span> <span class="o">=</span> <span class="n">browser</span><span class="o">.</span><span class="n">close_matches</span><span class="p">(</span><span class="s2">&quot;Fragment Analyzing&quot;</span><span class="p">)</span>
<span class="p">[</span><span class="n">ot</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">ot</span> <span class="ow">in</span> <span class="n">ots</span><span class="p">]</span>
<span class="c1"># [&#39;Fragment Analyzing&#39;, &#39;Fragment Analyzing (EL)&#39;, &#39;Fragment Analyzing&#39;]</span>
</pre></div>
</div>
</div>
<div class="section" id="relationship-browsing">
<h2>Relationship Browsing<a class="headerlink" href="#relationship-browsing" title="Permalink to this headline">¶</a></h2>
<p>The browser provides methods to making efficient server queries using its defined
model relationships. Whereas typically, the user would have to write a series
of efficient server queries, cache the results and merge the models, the browser
provides all of this logic in the convinient ‘retrieve’ and ‘recursive_retrieve’ methods.
Using the browser.retrieve or browser.recursive_retrieve results in massive speed improvements
for most trident scripts (&gt;10X, depending on size of query)</p>
<p>The following example retrieves
any data_association attached to an item whose sample has a name that matched ‘mcherry’.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">samples</span> <span class="o">=</span> <span class="n">browser</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;.*mCherry.*&quot;</span><span class="p">,</span> <span class="n">sample_type</span><span class="o">=</span><span class="s2">&quot;Fragment&quot;</span><span class="p">)</span>
<span class="n">items</span> <span class="o">=</span> <span class="n">browser</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="s1">&#39;items&#39;</span><span class="p">)</span>
<span class="n">data_associations</span> <span class="o">=</span> <span class="n">browser</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="s1">&#39;data_associations&#39;</span><span class="p">)</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">searched:</span>
<span class="sd">    123 samples</span>
<span class="sd">    871 items</span>
<span class="sd">    477 data associations</span>
<span class="sd">    8.9 seconds using 5 queries</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre></div>
</div>
<p>The ‘retrieve’ function will also automatically cache the results into the model so
they may be accessed later:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">samples</span> <span class="o">=</span> <span class="n">browser</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;.*mCherry.*&quot;</span><span class="p">,</span> <span class="n">sample_type</span><span class="o">=</span><span class="s2">&quot;Fragment&quot;</span><span class="p">)</span>
<span class="n">browser</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="s1">&#39;items&#39;</span><span class="p">)</span>

<span class="n">samples</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">items</span>  <span class="c1"># already cached from &#39;retrieve&#39;</span>
</pre></div>
</div>
<p>TODO: RECURSIVE RETRIEVE EXAMPLE</p>
<p>TODO: CACHE EXPLANATION</p>
<div class="section" id="avoid-using-too-many-queries-n-1-problem">
<h3>Avoid using too many queries (N+1 problem)<a class="headerlink" href="#avoid-using-too-many-queries-n-1-problem" title="Permalink to this headline">¶</a></h3>
<p>TLDR; <strong>AVOID FOR LOOPS</strong> <em>Use browser.retrieve whenever possible to
avoid making unnecessary requests</em></p>
<p>With the ease of making query requests in trident, it can be
easy to forget that each query puts a load on the online Aquarium server.
Poorly written Python code that makes many trident queries can translate into global
Aquarium slowdowns for everyone using that server.</p>
<p>Generally, you should write your code to minimize the number of queries made. For example,
the following code retrieves all items from a list of samples, and then retrieves all data
associated with those items. When this example was run, 100 samples, 871 items, and 471 data_associations
were retrieved in just 4 seconds:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># GOOD CODE (exactly 3 requests to server)</span>
<span class="c1">## 20 samples: completes in 0.8 seconds for 20 samples on AWS</span>
<span class="c1">## 100 samples: completes in 3.9 seconds for 100 samples on AWS</span>

<span class="n">items</span> <span class="o">=</span> <span class="n">browser</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="s1">&#39;items&#39;</span><span class="p">)</span> <span class="c1"># 1 request to server</span>
<span class="n">data_associations</span> <span class="o">=</span> <span class="n">browser</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="s1">&#39;data_associations&#39;</span><span class="p">)</span>  <span class="c1"># 2 requests to server</span>
</pre></div>
</div>
<p>Using a series of nested for loops that makes queries is an example of <strong>exceptionally bad</strong> code,
as in the following example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># BAD CODE (makes N^3 requests to server)</span>
<span class="c1">## 20 samples: completes in &gt;12 seconds for 20 samples on AWS</span>
<span class="c1">## 100 samples: completes &gt; 60 seconds</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">items</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">+=</span> <span class="n">i</span><span class="o">.</span><span class="n">data_associations</span>
</pre></div>
</div>
</div>
<div class="section" id="the-browser-cache">
<h3>The Browser Cache<a class="headerlink" href="#the-browser-cache" title="Permalink to this headline">¶</a></h3>
<p>By default, the browser caches query results and retrieves them in later operations.</p>
<p>TODO: This section is not finished…</p>
</div>
</div>
<div class="section" id="logging-requests">
<h2>Logging Requests<a class="headerlink" href="#logging-requests" title="Permalink to this headline">¶</a></h2>
<p>If you want to see what the browser is doing, you can turn on verbose mode:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">browser</span><span class="o">.</span><span class="n">set_verbose</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>If you want to see information for each of the requests you are making, you may also turn
on verbose mode for the session object. This is very useful for parsing
slow python code.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">session</span><span class="o">.</span><span class="n">set_verbose</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="asynchrounous-requests">
<h2>Asynchrounous Requests<a class="headerlink" href="#asynchrounous-requests" title="Permalink to this headline">¶</a></h2>
<p>As long as you are being mindful of the number of requests you are making,
trident provides methods for making parallel requests to speed up
your trident scripts.</p>
<p>The ‘make_async’ decorator located in ‘pydent.utils’ can make any function
asynchrounous, provided they use a list as its first argument and returns
a list.</p>
<p>‘make_async’ takes in a ‘chunk_size’ argument, which will divide the first argument
(a list) into a number of chunks of size ‘chunk_size’ and run
each chunk simulatenously. The value that is returned is the concatenation of all of
the lists returned by each chunk once all chunks have been completed.</p>
<p>For example, the following gets samples based on their id and will split the ids
into chunks of size 50. This outperforms (only slightly) an equivalent
non-asynchronous method. While the performance improvement is slight in this example,
longer running processes can have great improvements by running them asynchrounously.
You may have to experiment with the ‘chunk_size’ to get the best performance.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pydent.utils</span> <span class="k">import</span> <span class="n">make_async</span>

<span class="nd">@make_async</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="n">progress_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_samples_async</span><span class="p">(</span><span class="n">sample_ids</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">Sample</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">sample_ids</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_samples</span><span class="p">(</span><span class="n">sample_ids</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">Sample</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">sample_ids</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that it is not currently possible to use a async method nested within a async method.
An exception will be raised if this occurs. The planner, for example, already uses async methods.</p>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2017, University of Washington.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.1.1.<br/>
    </p>
  </div>
</footer>
  </body>
</html>